#include "../include/self_encoder.h"
#include "../include/self_observation.h"

static const float psi_s_w0[PSI_S_V][PSI_S_H] = 
                                               {{-0.0662,  0.3452, -0.3113,  0.1355, -0.1227,  0.1908,  0.0846,  0.2394,  0.6991, -0.4368, -0.0878,  0.7022,  0.3299,  0.3813, -0.1453,  0.1490, -0.3326,  0.0430},
                                                {-0.4683, -0.1766,  0.1659, -0.2728,  0.2527,  0.0585, -0.0269,  0.1027,  0.0485, -0.0892, -0.4915, -0.5159,  0.1689,  0.1008, -0.3050,  0.1804,  0.0541, -0.1983},
                                                { 0.2333, -0.2491,  0.1221, -0.0032, -0.1882,  0.0468,  0.1509,  0.4143,  0.0279, -0.5042, -0.2667, -0.4767, -0.1078, -0.6814,  0.0076, -0.2941,  0.0747, -0.0172},
                                                { 0.2144, -0.1406,  0.2780,  0.4513,  0.1943, -0.1525,  0.2180,  0.1255, -0.2388, -0.1287,  0.3059,  0.0472,  0.0552,  0.3991,  0.0157, -0.0153, -0.1694, -0.0279},
                                                {-0.0246, -0.2286,  0.0516, -0.0038,  0.0427, -0.0857, -0.3547, -0.2948,  0.3701, -0.3303, -0.0064, -0.6275, -0.2725, -0.0279, -0.0233,  0.0866, -0.0221,  0.2275},
                                                {-0.3314, -0.2148,  0.1179,  0.1803, -0.0418, -0.3289,  0.1683,  0.2426,  0.3655, -0.2856,  0.0922,  0.2120,  0.3931,  0.3006,  0.0901, -0.0054, -0.2338, -0.0853},
                                                {-0.1393, -0.2347,  0.0131, -0.2020, -0.3871,  0.3052, -0.4132,  0.0293,  0.0044, -0.0433, -0.4579, -0.0112,  0.1834,  0.1635, -0.2135, -0.2554, -0.2808,  0.3194},
                                                { 0.6233,  0.0428, -0.2972,  0.3854,  0.1641, -0.1369, -0.0290,  0.1973,  0.6751, -0.3663, -0.4210,  0.2197,  0.0473,  0.1738,  0.5842,  0.3289, -0.0873,  0.3057},
                                                {-0.0086,  0.0979, -0.0659,  0.2710, -0.1330, -0.2632,  0.2494,  0.0199,  0.1356,  0.1464, -0.2420, -0.0307,  0.1209, -0.2244, -0.1368,  0.0175, -0.3494,  0.1585},
                                                { 0.2642, -0.0339, -0.5516, -0.2765, -0.0681, -0.4706, -0.3218,  0.2690, -0.2179, -0.0846, -0.1271,  0.1376, -0.3665, -0.3318,  0.1813, -0.2635, -0.1976,  0.1428},
                                                {-0.2205,  0.2181,  0.0107, -0.0930,  0.3627, -0.0281,  0.0598,  0.0595, -0.4494, -0.1360, -0.1005,  0.5787,  0.0489,  0.0827,  0.3912,  0.1166,  0.2322,  0.0515},
                                                { 0.2817, -0.5139, -0.0217,  0.2580, -0.1518,  0.2917, -0.5457,  0.3771,  0.5212, -0.3686, -0.2467, -0.3812, -0.1057, -0.5984,  0.0037, -0.3689, -0.2234, -0.0347},
                                                {-0.1918, -0.1030, -0.6120,  0.0584, -0.1612, -0.1658, -0.3394, -0.1159, -0.0414, -0.1935,  0.0199, -0.6832, -0.1298, -0.0702,  0.2351, -0.1735,  0.0778,  0.1048},
                                                { 0.1406, -0.0630,  0.0402, -0.1023, -0.1967, -0.1072,  0.3123,  0.4231,  0.4700,  0.0201, -0.4529,  0.3023, -0.0613, -0.0145,  0.0573, -0.3353, -0.1141,  0.2823},
                                                { 0.2242, -0.1356, -0.2215, -0.2183, -0.1892, -0.2922,  0.0647, -0.3096,  0.1227,  0.0945, -0.1477, -0.5202,  0.6107, -0.0830, -0.2246, -0.0332, -0.3552, -0.3099},
                                                {-0.2605,  0.1200, -0.2905, -0.2414, -0.1508,  0.0824, -0.4199,  0.4743, -0.7421, -0.3876,  0.3022,  0.1035, -0.5520, -0.2008,  0.0393, -0.0935,  0.3028,  0.1908}};




static const float psi_s_w1[PSI_S_V][PSI_S_V] = 
                                                    {{ 1.9581e-01,  5.3327e-02,  3.6715e-01, -1.1817e-01,  2.8837e-01,9.8057e-02,  7.4590e-02,  5.7743e-01,  8.0308e-02,  4.2634e-01,4.3457e-01,  4.7408e-01,  3.8704e-01,  3.0703e-01, -4.0900e-01,3.0138e-01      },
                                                     {-1.6066e-01,  4.9240e-01, -4.2024e-01, -1.4680e-01, -5.1533e-01,7.5000e-02,  1.7595e-01, -4.2977e-02, -2.4217e-01,  2.5096e-01,-2.5555e-03, -4.1754e-01, -3.2590e-02, -2.4556e-01,  1.5678e-01,3.7005e-01     },
                                                     {-1.3250e-01,  1.4054e-01, -2.6032e-01,  2.5570e-01, -1.1610e-01,1.9535e-01,  8.3425e-02, -5.0316e-02,  2.1941e-01, -3.9512e-01,-4.1106e-01,  1.8835e-01,  3.1899e-04, -2.2109e-01, -1.0922e-01,-1.1184e-01    },
                                                     { 2.3445e-01,  1.5436e-01,  1.1519e-01,  8.4605e-02, -1.7936e-01,2.7795e-01, -2.3522e-01,  2.7890e-01, -2.6846e-01,  8.3189e-02,7.8286e-03,  2.9490e-01,  4.5604e-01,  9.2201e-03,  3.1857e-01,-2.7782e-01     },
                                                     { 6.1801e-02,  3.8141e-01,  1.5012e-01,  9.6598e-02, -3.9146e-01,-3.8188e-01, -2.8867e-01, -5.0792e-02, -1.0945e-02, -6.9323e-02,4.2257e-01,  1.2646e-01, -3.2491e-02, -2.3882e-01,  8.4930e-02,-1.8734e-01    },
                                                     { 3.4958e-01, -1.5469e-01, -4.8494e-01, -2.2917e-01, -1.2637e-01,4.1461e-01,  1.9887e-01, -1.8798e-01,  2.8988e-01, -6.9427e-02,4.2089e-01, -2.1884e-01,  2.9137e-01, -4.8625e-02, -2.1367e-01,3.1088e-01      },
                                                     { 2.8374e-02, -2.4576e-01, -4.0544e-02, -4.8397e-01,  3.3958e-01,-3.6039e-02,  3.1874e-01, -1.5216e-01, -3.6724e-01, -2.9763e-01,3.7866e-01,  1.4657e-01, -2.1168e-01, -3.5354e-01, -2.0552e-01,-1.5328e-01    },
                                                     { 9.3689e-02, -3.1999e-01,  2.7953e-01,  2.8219e-01,  2.4587e-01,3.4304e-01, -1.8565e-01, -3.4398e-01, -2.3130e-01, -4.5904e-01,1.6217e-01,  1.0514e-01, -3.1147e-01, -1.1060e-01,  2.1064e-01,9.8844e-02      },
                                                     { 1.1079e-01, -1.0003e-01, -1.7026e-01, -2.7861e-01, -2.8503e-01,3.0852e-01, -1.6946e-01,  2.7983e-01, -2.0090e-01,  3.4971e-01,-3.1150e-01,  2.3411e-02,  2.1674e-01, -2.3583e-01,  8.4774e-02,-1.6775e-02    },
                                                     { 3.5231e-01,  3.9967e-01,  2.6734e-01, -2.6958e-02,  4.7094e-02,2.4331e-01,  2.7943e-01, -2.5235e-01, -1.4126e-01,  3.0374e-01,-4.9282e-02, -3.0586e-01, -1.0886e-01,  3.1441e-01, -4.5516e-01,-1.9011e-01    },
                                                     { 1.3537e-02, -3.8242e-02,  3.6228e-01,  4.2222e-02,  3.1370e-01,-1.0915e-01, -1.6676e-01, -3.4093e-01,  1.3025e-01,  3.1174e-01,6.5209e-02,  9.0264e-03,  3.8307e-01,  1.1739e-01,  1.8726e-01,-1.8879e-01    },
                                                     { 3.1748e-01,  1.6982e-01,  4.5055e-01,  1.1478e-01,  1.8107e-01,1.8439e-01,  3.6778e-01, -1.5626e-01,  3.3904e-01, -7.0071e-02,-3.7640e-01,  1.5829e-01,  4.3535e-01, -2.1402e-02,  1.1310e-01,-1.9487e-01    },
                                                     {-4.0641e-01,  7.7237e-02,  1.6306e-01, -2.1728e-01,  2.6732e-01,-9.2251e-02,  2.1546e-01, -1.8759e-01, -2.7305e-01,  1.5863e-01,-1.5372e-01, -2.1420e-01,  1.1866e-01, -1.2151e-02, -2.9213e-01,2.3631e-01    },
                                                     {-3.4916e-01,  6.7106e-03, -1.2481e-01, -3.2595e-01,  1.5743e-01,-1.8672e-02,  8.6956e-02, -2.7569e-01,  5.5803e-02, -1.8629e-01,-5.7327e-02,  3.5916e-01,  3.7832e-01, -1.7097e-01,  4.0584e-01,-2.3531e-01   },
                                                     { 3.7445e-01, -3.7032e-01,  3.1318e-02, -2.9446e-01,  4.3544e-01,7.3776e-02,  3.9327e-01,  2.6036e-01, -1.8300e-01, -3.3134e-01,3.6208e-02,  4.4270e-01,  1.0135e-02,  1.5132e-01,  3.5430e-01,-3.1990e-01     },
                                                     { 3.1519e-01, -2.1691e-01, -5.9664e-01,  1.9881e-01, -2.2782e-01,-3.4393e-02, -2.2044e-01,  4.5168e-01,  3.9545e-01, -2.7917e-01,1.3510e-01,  5.4833e-02, -5.1843e-01,  7.2694e-02, -2.3412e-01,-1.6568e-01    }};


static const float psi_s_b0[PSI_S_V] = {0.2276,  0.0345,  0.2541, -0.2226,  0.1145,  0.0618,  0.1488,  0.2155, -0.1619,  0.1102,  0.2277,  0.3863,  0.2162,  0.0595,  0.1464,  0.1720};
static const float psi_s_b1[PSI_S_V] = { 0.1128,  0.0906,  0.0120,  0.0400,  0.1909,  0.1306, -0.0103,  0.0698, 0.1583, -0.1146,  0.0655,  0.0491,  0.0940,  0.2372,  0.0860,  0.0875};

static int       getSelfEncoderOutputSize();
static int       getSelfEncoderOutput0Size();
static int       getEncoderInputSize();

static void    feedForwardSelfEncoder(float* inp, float* dst);
static void    feedForwardPsiS(float* inp, float* dst);
static void    feedForwardPsiS0(float* inp, float* dst,int k);
static void    feedForwardPsiS1(float* inp, float* dst,int k);


void calcSelfEncoderOutput(float* inp, float* dst)
{
    feedForwardSelfEncoder(inp, dst);
}

static void feedForwardSelfEncoder(float* inp, float* dst)
{
    feedForwardPsiS(inp, dst);
}


static void  feedForwardPsiS(float* inp, float* dst)
{
    float out0[getSelfEncoderOutput0Size()];
    for(int k = 0; k < getSelfEncoderOutputSize(); k++)
    {
        feedForwardPsiS0(inp, out0, k);
    }   

    float out1[getSelfEncoderOutput0Size()];
    for(int k = 0; k < getSelfEncoderOutputSize(); k++)
    {
        feedForwardPsiS1(out0, out1, k);
    }   
}


static void feedForwardPsiS0(float* inp, float* out, int raw)
{
    int sz        = getEncoderInputSize();
    float temp    = 0.0;    

    for(int k = 0; k < sz; k++)
    {
        temp += psi_s_w0[raw][k]*inp[k];
    }

    out[raw] = temp + psi_s_b0[raw];
}

static void feedForwardPsiS1(float* inp, float* out, int raw)
{
    int sz        = getSelfEncoderOutputSize();
    float temp    = 0.0;    

    for(int k = 0; k < sz; k++)
    {
        temp += psi_s_w1[raw][k]*inp[k];
    }

    out[raw] = temp + psi_s_b1[raw];
}


static int getEncoderInputSize()
{
    return (int)PSI_S_H;
}

static int getSelfEncoderOutputSize()
{
    return (int)PSI_S_V;
}

static int getSelfEncoderOutput0Size()
{
    return (int)PSI_S_V;
}

