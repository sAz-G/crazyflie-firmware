/**
 * ,---------,       ____  _ __
 * |  ,-^-,  |      / __ )(_) /_______________ _____  ___
 * | (  O  ) |     / __  / / __/ ___/ ___/ __ `/_  / / _ \
 * | / ,--Â´  |    / /_/ / / /_/ /__/ /  / /_/ / / /_/  __/
 *    +------`   /_____/_/\__/\___/_/   \__,_/ /___/\___/
 *
 * Crazyflie control firmware
 *
 * Copyright (C) 2019 Bitcraze AB
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, in version 3.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 *
 * hello_world.c - App layer application of a simple hello world debug print every
 *   2 seconds.
 */


#include <string.h>
#include <stdint.h>
#include <stdbool.h>

#include "app.h"

#include "FreeRTOS.h"
#include "task.h"

#include "debug.h"
#include "radiolink.h"
#include "param.h"
#include "log.h"
#include "configblock.h"
#include "stabilizer_types.h"
#include "commander.h"
#include "estimator_kalman.h"
#include "stabilizer.h"
#include "math3d.h"
#include "../include/coll_avoid_main.h"
#include "motors.h"

#define NGHBRS 6
#define NGHBRSDIM 6 
#define NDRNS 8


void networkEvaluate(control_t_n* control_n, const float* state_array);
int main_nn(float *outdatav);
Vector3 getPosition(void);
Vector3 getVeloc(void);
float clip(float val, float min, float max);

float linear(float num) {
	return num;
}


float sigmoid(float num) {
	return 1 / (1 + exp(-num));
}


float relu(float num) {
	if (num > 0) {
		return num;
	} else {
		return 0;
	}
}

static const int structure [6][2] = {{6, 8},{8, 8},{18, 16},{16, 16},{24, 32},{32, 4}};


static const int NEIGHBORS = NGHBRS;
static const int NBR_DIM = NGHBRSDIM; 
static const int NUMQUADS = NDRNS; 
static int farthestNeighb = 0;
static int lastAdded = 1;
static int timer = 0;
static PacketData ownPacket;
uint8_t highlvl = 0;

static float output_0[8];
static float output_1[8];
static float output_2[16];
static float output_3[16];
static float inputff[24];
static float output_4[32];
static float output_5[4];


static float mototrKValue = 1.0f;
static float thrusts[4]   = {0.f, 0.f, 0.f, 0.f};
static uint16_t thrustsToMotor[4];
static float dronesInfo[NDRNS][NGHBRSDIM];
static float kNearestArr[NGHBRS][NGHBRSDIM];
static float ownTarget[3] = {.0f, 0.f, .5f};
static struct mat33 rot;
static float state_array[18];
static int state = 0;

static const float actor_encoder_neighbor_encoder_embedding_mlp_0_weight[6][8] = {{0.5416633486747742,0.5207025408744812,0.4606701135635376,0.541625440120697,-0.030595339834690094,-0.41178369522094727,0.8232560157775879,0.3432365655899048},{-0.6793858408927917,-0.7075570225715637,-0.6019311547279358,-0.5736227035522461,-0.13287974894046783,0.32565295696258545,-0.19622144103050232,-0.3765560984611511},{-0.6420764327049255,-0.4285285174846649,-0.37280139327049255,0.08217182755470276,0.13821372389793396,0.26669827103614807,0.1271458864212036,-0.7889770269393921},{0.09204913675785065,-0.1277514547109604,-0.3767601549625397,-0.44940185546875,0.16801367700099945,-0.4095054864883423,-0.15770114958286285,0.08556654304265976},{-0.23749549686908722,0.33927252888679504,0.45328933000564575,0.4473400115966797,-0.03746205195784569,-0.09976258128881454,-0.26105400919914246,0.2209974229335785},{-0.13850753009319305,-0.1915159970521927,0.25898477435112,0.005928817205131054,-0.34477144479751587,-0.21939535439014435,0.266299307346344,0.2198306918144226}};
static const float actor_encoder_neighbor_encoder_embedding_mlp_2_weight[8][8] = {{-0.03251625597476959,0.0012665789108723402,-0.8452470302581787,0.3090740144252777,-0.5916076898574829,-0.07894216477870941,-0.7719787359237671,-0.8175962567329407},{-0.38134801387786865,0.22348414361476898,-0.6054815053939819,0.14779238402843475,0.03200463578104973,0.37273523211479187,-0.5186449885368347,-0.2076832801103592},{0.24380429089069366,0.3389277458190918,-0.5954283475875854,-0.5685044527053833,0.4022670090198517,0.4588146507740021,0.5485462546348572,0.365100234746933},{-0.3070105314254761,-0.6072970628738403,0.04033582657575607,0.38580095767974854,0.41339126229286194,-0.29711103439331055,-0.18148839473724365,0.1921238899230957},{-0.17432427406311035,0.3429899215698242,-0.2122931331396103,-0.13173352181911469,-0.022895516827702522,0.5695515871047974,0.4534667134284973,-0.0007198587991297245},{0.3579081594944,-0.6856699585914612,-0.270844042301178,0.543065071105957,-0.01728454977273941,-0.23766610026359558,-0.07974095642566681,0.04554393142461777},{0.29315465688705444,-1.1740769147872925,-0.20248886942863464,-0.2370309680700302,-0.24415399134159088,-0.18596145510673523,-0.07535210251808167,-0.17138516902923584},{-0.13260476291179657,-0.33564692735671997,0.2681557536125183,-0.5313069820404053,-0.4661141037940979,-0.8401055932044983,-0.16072696447372437,-0.44614166021347046}};

static const float actor_encoder_self_encoder_0_weight[18][16] = {{-0.06618855893611908,-0.4682655930519104,0.23326344788074493,0.21436387300491333,-0.02455030381679535,-0.3313743770122528,-0.13932602107524872,0.6233210563659668,-0.008553671650588512,0.2641511857509613,-0.22054821252822876,0.2816796898841858,-0.19181978702545166,0.14063389599323273,0.224188432097435,-0.26053351163864136},{0.34523943066596985,-0.17655561864376068,-0.2490684539079666,-0.14060582220554352,-0.22861914336681366,-0.21482554078102112,-0.2346857488155365,0.042757246643304825,0.09791561216115952,-0.033856987953186035,0.2180703580379486,-0.5139243602752686,-0.10297846049070358,-0.06296567618846893,-0.13563241064548492,0.11999639868736267},{-0.3112786114215851,0.16594672203063965,0.12214522063732147,0.27797189354896545,0.05158013105392456,0.1179249957203865,0.013102566823363304,-0.2971605062484741,-0.0659274235367775,-0.5515859127044678,0.010670223273336887,-0.021655678749084473,-0.6120285987854004,0.040217626839876175,-0.22148281335830688,-0.2904934883117676},{0.13547925651073456,-0.2727769613265991,-0.0032051932066679,0.4512733817100525,-0.0038066646084189415,0.18029309809207916,-0.20200781524181366,0.38536226749420166,0.27104371786117554,-0.27653029561042786,-0.09295175969600677,0.25801700353622437,0.05835697427392006,-0.10225972533226013,-0.2182742804288864,-0.241376131772995},{-0.12269207090139389,0.25269660353660583,-0.1882457584142685,0.19429822266101837,0.042715076357126236,-0.041821859776973724,-0.3871012032032013,0.16413600742816925,-0.1330069899559021,-0.0681423544883728,0.3626581132411957,-0.15183305740356445,-0.16122664511203766,-0.19665837287902832,-0.1892404407262802,-0.15075303614139557},{0.19081081449985504,0.05846159905195236,0.046793967485427856,-0.15254147350788116,-0.08573547750711441,-0.3289237320423126,0.30516886711120605,-0.1368534415960312,-0.2631857395172119,-0.4705716371536255,-0.02814868465065956,0.2917014956474304,-0.16578960418701172,-0.1071624681353569,-0.29223981499671936,0.08241933584213257},{0.08459187299013138,-0.026889145374298096,0.15089043974876404,0.2180132269859314,-0.3547452390193939,0.16831021010875702,-0.4132370948791504,-0.029036615043878555,0.24940012395381927,-0.3218213617801666,0.059753384441137314,-0.5456989407539368,-0.3394419550895691,0.3122645318508148,0.06469226628541946,-0.4199342727661133},{0.23935243487358093,0.10265571624040604,0.4143328368663788,0.12546367943286896,-0.29483383893966675,0.2425520420074463,0.02928278036415577,0.19729532301425934,0.01987949199974537,0.268984317779541,0.05945969000458717,0.37711459398269653,-0.11585471779108047,0.42305710911750793,-0.3096311688423157,0.47426438331604004},{0.699114203453064,0.04853653907775879,0.027854755520820618,-0.2387508600950241,0.37012434005737305,0.3654761016368866,0.004397778771817684,0.6751405000686646,0.135589137673378,-0.21794165670871735,-0.44936612248420715,0.5211969614028931,-0.04139780253171921,0.4699978828430176,0.12274768948554993,-0.7421208024024963},{-0.4368140995502472,-0.08916362375020981,-0.504176676273346,-0.12866270542144775,-0.3302658498287201,-0.28557902574539185,-0.04326285421848297,-0.3662857711315155,0.14638282358646393,-0.08455868810415268,-0.13598717749118805,-0.3686465620994568,-0.19347645342350006,0.020055335015058517,0.0945129320025444,-0.3875903785228729},{-0.08781720697879791,-0.4914935529232025,-0.26672059297561646,0.30586785078048706,-0.006350978743284941,0.09221944957971573,-0.45791080594062805,-0.42099130153656006,-0.24199257791042328,-0.1270504593849182,-0.10051459074020386,-0.24667926132678986,0.019921405240893364,-0.4528962969779968,-0.14768922328948975,0.30217909812927246},{0.7021660804748535,-0.5159429311752319,-0.47665634751319885,0.04716300219297409,-0.6274789571762085,0.21197697520256042,-0.011171729303896427,0.2197422981262207,-0.030663825571537018,0.13759413361549377,0.5787284970283508,-0.3811739385128021,-0.6831509470939636,0.3022986650466919,-0.5201964378356934,0.1035190224647522},{0.329903781414032,0.16888202726840973,-0.10784818977117538,0.05521199479699135,-0.2724592685699463,0.3930879235267639,0.18336284160614014,0.04728676751255989,0.12094713002443314,-0.36649763584136963,0.048852965235710144,-0.10574519634246826,-0.12976378202438354,-0.06134617328643799,0.6107184290885925,-0.5520267486572266},{0.38129177689552307,0.10078997164964676,-0.6814368367195129,0.3990724980831146,-0.027947982773184776,0.3006038963794708,0.16351661086082458,0.1737658530473709,-0.22435028851032257,-0.33180171251296997,0.08273129165172577,-0.5984392166137695,-0.07022816687822342,-0.014451928436756134,-0.08303523808717728,-0.20080284774303436},{-0.1453278511762619,-0.3050162196159363,0.007555623073130846,0.015742244198918343,-0.02325281873345375,0.09013322740793228,-0.2134876549243927,0.5841560959815979,-0.1367831975221634,0.18127790093421936,0.3912259340286255,0.0037465339992195368,0.23505598306655884,0.05727379024028778,-0.22463496029376984,0.03929801657795906},{0.1489643156528473,0.18041206896305084,-0.2940790057182312,-0.015345738269388676,0.08664921671152115,-0.005434525664895773,-0.25543007254600525,0.3289170563220978,0.017469581216573715,-0.26347601413726807,0.11663094907999039,-0.36886200308799744,-0.17346520721912384,-0.33531683683395386,-0.033203985542058945,-0.09347021579742432},{-0.33259573578834534,0.054078537970781326,0.07472864538431168,-0.16942572593688965,-0.022093789651989937,-0.2338176816701889,-0.28080061078071594,-0.08733955025672913,-0.3493819534778595,-0.19761452078819275,0.23215577006340027,-0.22335466742515564,0.07783006131649017,-0.11411971598863602,-0.3552263379096985,0.3027816712856293},{0.04298582673072815,-0.19832105934619904,-0.017174197360873222,-0.027873311191797256,0.22748404741287231,-0.08526260405778885,0.3193904459476471,0.3056783974170685,0.1585237830877304,0.14276906847953796,0.051532894372940063,-0.0347084105014801,0.10484613478183746,0.28234004974365234,-0.3098936378955841,0.19080698490142822}};
static const float actor_encoder_self_encoder_2_weight[16][16] = {{0.19581374526023865,-0.16065792739391327,-0.1325000375509262,0.23445087671279907,0.06180119514465332,0.3495830297470093,0.028374124318361282,0.09368909895420074,0.11079078167676926,0.3523145020008087,0.013536926358938217,0.3174806833267212,-0.40640783309936523,-0.3491607904434204,0.3744545578956604,0.31518691778182983},{0.05332746356725693,0.4923967123031616,0.14053820073604584,0.15435799956321716,0.3814096450805664,-0.15468858182430267,-0.2457607537508011,-0.31999167799949646,-0.10002576559782028,0.3996659219264984,-0.038242142647504807,0.16982311010360718,0.07723691314458847,0.00671060336753726,-0.3703245222568512,-0.21690918505191803},{0.3671475052833557,-0.4202384352684021,-0.2603161036968231,0.11518771946430206,0.15011733770370483,-0.48493969440460205,-0.04054353013634682,0.2795336842536926,-0.17025648057460785,0.26734215021133423,0.3622780442237854,0.4505474865436554,0.1630631536245346,-0.12481006979942322,0.03131761774420738,-0.5966444611549377},{-0.11816670745611191,-0.14679580926895142,0.25570032000541687,0.08460529148578644,0.09659798443317413,-0.22917425632476807,-0.48396754264831543,0.2821887731552124,-0.27860862016677856,-0.02695808932185173,0.04222232475876808,0.11477648466825485,-0.21727731823921204,-0.32594728469848633,-0.2944566011428833,0.19880984723567963},{0.2883707582950592,-0.5153295993804932,-0.11609632521867752,-0.1793573498725891,-0.3914560377597809,-0.12637047469615936,0.3395843207836151,0.2458709180355072,-0.2850319743156433,0.04709378257393837,0.31369855999946594,0.181072399020195,0.26731714606285095,0.15742842853069305,0.4354444146156311,-0.22782321274280548},{0.09805718809366226,0.07500048726797104,0.19535169005393982,0.2779462933540344,-0.3818823993206024,0.41460898518562317,-0.03603888675570488,0.3430365025997162,0.3085187077522278,0.24331238865852356,-0.10915331542491913,0.1843860000371933,-0.09225142002105713,-0.01867188699543476,0.07377612590789795,-0.034392546862363815},{0.07459037750959396,0.17594662308692932,0.08342459052801132,-0.23521775007247925,-0.28866925835609436,0.19886697828769684,0.3187422752380371,-0.1856517344713211,-0.16945555806159973,0.2794255316257477,-0.16676321625709534,0.36777523159980774,0.21546384692192078,0.08695615082979202,0.39327019453048706,-0.22043579816818237},{0.5774343013763428,-0.04297741502523422,-0.050316255539655685,0.27889612317085266,-0.05079246684908867,-0.18797722458839417,-0.15215782821178436,-0.3439840078353882,0.2798319458961487,-0.2523459792137146,-0.34092631936073303,-0.1562633216381073,-0.18759413063526154,-0.2756895124912262,0.26036307215690613,0.45168307423591614},{0.08030841499567032,-0.24216854572296143,0.21940535306930542,-0.26846250891685486,-0.010944927111268044,0.28988078236579895,-0.36723583936691284,-0.2312989979982376,-0.2008955180644989,-0.1412642002105713,0.13024665415287018,0.3390401601791382,-0.27305230498313904,0.0558025948703289,-0.18300168216228485,0.3954538106918335},{0.42634108662605286,0.25096049904823303,-0.39512038230895996,0.08318912237882614,-0.0693226307630539,-0.06942731142044067,-0.2976316511631012,-0.45904114842414856,0.3497118651866913,0.3037402033805847,0.31174159049987793,-0.07007114589214325,0.15863002836704254,-0.18629370629787445,-0.33133548498153687,-0.2791652977466583},{0.4345746636390686,-0.0025555419269949198,-0.4110617935657501,0.007828610949218273,0.4225703179836273,0.4208861291408539,0.37865519523620605,0.1621704399585724,-0.3115018904209137,-0.04928165674209595,0.06520876288414001,-0.37639960646629333,-0.15371863543987274,-0.057327114045619965,0.036208316683769226,0.13510103523731232},{0.47408321499824524,-0.41754093766212463,0.18834659457206726,0.2949020564556122,0.12645526230335236,-0.21884146332740784,0.14656522870063782,0.1051386222243309,0.023411419242620468,-0.30585676431655884,0.00902643334120512,0.15829449892044067,-0.21420226991176605,0.35915622115135193,0.44269993901252747,0.05483255535364151},{0.38703516125679016,-0.03258951008319855,0.0003189929702784866,0.4560370445251465,-0.032490551471710205,0.29137036204338074,-0.21167893707752228,-0.31147322058677673,0.2167380452156067,-0.10885892063379288,0.3830718696117401,0.4353487193584442,0.11865925788879395,0.3783228397369385,0.010135279037058353,-0.5184333920478821},{0.30703306198120117,-0.24555787444114685,-0.22109191119670868,0.009220142848789692,-0.2388203740119934,-0.04862460866570473,-0.35353848338127136,-0.11060307919979095,-0.23583242297172546,0.3144078850746155,0.11738694459199905,-0.021402141079306602,-0.012150561437010765,-0.170969158411026,0.15131765604019165,0.07269381731748581},{-0.4089983403682709,0.1567835509777069,-0.10921986401081085,0.31856784224510193,0.08493030071258545,-0.21367397904396057,-0.20552080869674683,0.21064451336860657,0.08477360010147095,-0.4551626443862915,0.18726173043251038,0.11309585720300674,-0.2921326756477356,0.4058397114276886,0.3543039858341217,-0.2341206967830658},{0.3013814687728882,0.37005263566970825,-0.11183945089578629,-0.2778151333332062,-0.18733587861061096,0.3108842074871063,-0.15328499674797058,0.09884366393089294,-0.016774527728557587,-0.190111443400383,-0.18879356980323792,-0.19487358629703522,0.23630563914775848,-0.23530614376068115,-0.31990286707878113,-0.16568030416965485}};

static const float actor_encoder_feed_forward_0_weight[24][32] = {{-0.07122060656547546,0.23117747902870178,0.34822317957878113,-0.19481824338436127,-0.3057509958744049,-0.3279584050178528,-0.31828296184539795,-0.2827754616737366,0.14343956112861633,-0.09604082256555557,-0.29891452193260193,0.05090612173080444,0.27921798825263977,-0.29152724146842957,0.17993606626987457,0.08280419558286667,-0.129579097032547,-0.2050037682056427,0.23145782947540283,0.3323976397514343,0.27056506276130676,0.24709239602088928,-0.09527015686035156,-0.2504620850086212,0.22501416504383087,-0.28405600786209106,0.1976478099822998,-0.250850111246109,0.03419619798660278,0.11425723135471344,0.2873051166534424,0.2873195707798004},{-0.1064176931977272,-0.13081178069114685,0.03883078694343567,-0.20046277344226837,0.08442245423793793,0.030431702733039856,-0.035395845770835876,-0.29173845052719116,-0.2773192226886749,-0.16681286692619324,0.09738468378782272,0.22094504535198212,0.22591784596443176,0.12568508088588715,0.06435435265302658,-0.0055421036668121815,-0.008046874776482582,0.23517122864723206,-0.107376828789711,-0.12271304428577423,0.08830418437719345,-0.16403712332248688,0.152570441365242,-0.39780086278915405,0.01828138343989849,-0.030812328681349754,0.08291412889957428,-0.0386100709438324,-0.2647726833820343,-0.35372263193130493,0.024583294987678528,0.33624404668807983},{0.08294659852981567,0.2762773931026459,0.18349619209766388,-0.16127003729343414,-0.2720637321472168,-0.12321542203426361,-0.1625092625617981,0.021075408905744553,-0.09187214076519012,0.021565178409218788,-0.07516253739595413,0.21653950214385986,0.0741083100438118,-0.087873175740242,-0.10610347986221313,-0.10919120162725449,-0.21781687438488007,-0.3164195418357849,0.09578519314527512,0.02303292043507099,-0.1059456542134285,0.34478670358657837,0.49982336163520813,-0.24409769475460052,-0.08789532631635666,-0.3208954930305481,-0.28333744406700134,0.010374546982347965,-0.04723915085196495,-0.13875970244407654,-0.11454097181558609,-0.05361724644899368},{-0.061298470944166183,-0.3347325325012207,-0.06762755662202835,-0.19412805140018463,0.20925737917423248,-0.31379613280296326,-0.27393168210983276,-0.289509654045105,-0.14725972712039948,-0.07250766456127167,0.216703861951828,-0.1340232640504837,-0.1851392239332199,-0.22911231219768524,-0.17914476990699768,0.31571847200393677,0.2456604242324829,-0.2756171226501465,-0.30561625957489014,0.07261332869529724,-0.15338873863220215,0.04865657165646553,0.15817038714885712,0.20728828012943268,0.15495476126670837,-0.05743638053536415,0.00311665958724916,-0.02761693485081196,0.10229578614234924,0.14097388088703156,-0.1127624586224556,0.2923031747341156},{-0.10336794704198837,-0.15996526181697845,-0.26570871472358704,0.1434851884841919,0.15531782805919647,0.014982502907514572,0.2576178014278412,0.10788529366254807,0.1377517729997635,-0.3077482581138611,0.24026018381118774,-0.18551208078861237,0.154689759016037,-0.27119553089141846,0.14665701985359192,-0.045810382813215256,0.07252075523138046,-0.3283371329307556,-0.17386165261268616,0.08305242657661438,-0.1793564260005951,-0.03950417786836624,0.3574201762676239,0.16641181707382202,-0.21584481000900269,-0.04450172930955887,-0.5334388017654419,0.1403101235628128,0.036167096346616745,-0.08938127756118774,-0.14293272793293,0.3511260449886322},{0.18277709186077118,-0.31656613945961,-0.042873505502939224,-0.2192852646112442,-0.15306192636489868,-0.15576498210430145,0.08707164227962494,0.06268011033535004,-0.2876650393009186,-0.3069723844528198,0.08596356958150864,-0.29894980788230896,0.04138154536485672,0.08936181664466858,0.3778754770755768,0.2426333725452423,0.3180094361305237,-0.11050142347812653,0.014771945774555206,0.0844961628317833,0.10855382680892944,-0.23382793366909027,-0.1883874088525772,0.04202277585864067,-0.2640722393989563,-0.15315786004066467,-0.02339172177016735,-0.26324284076690674,0.15062488615512848,-0.24562886357307434,-0.3801262676715851,0.18033435940742493},{-0.18163251876831055,0.19857239723205566,0.018435554578900337,0.09838874638080597,-0.3527906835079193,-0.13374681770801544,-0.09587039053440094,-0.19955885410308838,0.0709359273314476,-0.27067872881889343,0.3202790319919586,-0.1611541509628296,-0.14824222028255463,0.004794650245457888,0.1610976755619049,-0.2036714255809784,-0.1448579877614975,0.026089079678058624,0.023654118180274963,-0.01872790977358818,0.20688815414905548,-0.10286185145378113,-0.08038976788520813,0.20924633741378784,-0.14164739847183228,-0.13907809555530548,-0.30623331665992737,-0.1365152895450592,0.21563084423542023,0.2090482860803604,0.035388778895139694,0.11317752301692963},{-0.1680467426776886,0.14501124620437622,-0.20279958844184875,-0.33248138427734375,0.09544134885072708,0.20847927033901215,-0.11094631254673004,-0.11036976426839828,-0.13536496460437775,0.22280116379261017,-0.11216648668050766,0.06839205324649811,-0.05303432047367096,0.046753257513046265,0.07345883548259735,-0.29363906383514404,-0.3226296007633209,-0.018598884344100952,-0.2699894607067108,-0.34235259890556335,0.07790566980838776,0.033418670296669006,-0.18954038619995117,-0.06485119462013245,-0.09990133345127106,0.012072972021996975,0.17733430862426758,0.0634545087814331,0.1035858765244484,-0.21974198520183563,0.3040514588356018,-0.16242249310016632},{0.2551875114440918,0.07518471777439117,0.1248006820678711,-0.06532985717058182,0.19206520915031433,-0.0798313096165657,-0.04728589579463005,-0.21809132397174835,-0.09572894871234894,0.35337886214256287,0.2362472265958786,-0.3343554139137268,-0.1750459522008896,-0.06378410011529922,-0.44735226035118103,0.20331154763698578,0.16051457822322845,-0.10719436407089233,-0.1113307774066925,0.5108001232147217,-0.14730103313922882,0.12579207122325897,0.32232317328453064,-0.1655619591474533,0.08859551697969437,-0.018897805362939835,0.2994450032711029,-0.3449319303035736,0.07710305601358414,-0.32653436064720154,0.23443908989429474,0.3294370770454407},{-0.052246928215026855,-0.36258208751678467,-0.2311490923166275,0.08682223409414291,0.051982756704092026,0.06112070009112358,-0.06722407042980194,-0.2592596411705017,0.12813220918178558,-0.10113509744405746,0.02483743615448475,-0.06682184338569641,0.27815401554107666,0.19427542388439178,-0.29052722454071045,0.2720559239387512,0.21440181136131287,0.04378288984298706,0.06539101153612137,0.19406776130199432,0.004612790420651436,-0.1725124716758728,-0.01816953346133232,-0.2019086331129074,-0.2419653832912445,0.23927216231822968,-0.10353629291057587,-0.3633733093738556,-0.29329079389572144,0.10821734368801117,0.07820646464824677,-0.19934087991714478},{0.15780344605445862,-0.18118417263031006,0.37586864829063416,0.1395072340965271,-0.37799134850502014,-0.1579839289188385,0.03445025160908699,0.050767119973897934,-0.2400546371936798,0.1423586905002594,0.20844122767448425,-0.20634189248085022,-0.23340341448783875,0.26900023221969604,-0.06187954172492027,0.018693571910262108,0.2628510594367981,0.03895225375890732,-0.30633190274238586,-0.14549891650676727,0.10691338032484055,-0.21945108473300934,0.17421500384807587,0.04208255931735039,0.18467678129673004,0.21064339578151703,0.07853983342647552,-0.19647079706192017,0.21291764080524445,0.07399206608533859,-0.18794475495815277,-0.14016282558441162},{0.22223933041095734,0.03856954723596573,0.2990722060203552,-0.3700125217437744,0.03427651524543762,-0.042867641896009445,0.20202946662902832,0.06407301127910614,-0.1319577693939209,-0.11418953537940979,0.1807422935962677,0.24291974306106567,-0.0487966388463974,-0.18859997391700745,-0.22198915481567383,-0.31398120522499084,0.18278948962688446,-0.28846800327301025,-0.08561421930789948,0.046462710946798325,-0.001942168571986258,0.17111876606941223,0.120306096971035,0.07874994724988937,-0.04870991408824921,-0.20151597261428833,0.139780193567276,0.013830902986228466,0.29552724957466125,-0.11925410479307175,0.29631349444389343,-0.26397407054901123},{0.29676610231399536,0.0552709735929966,0.2532472312450409,-0.05895678326487541,-0.3394722044467926,-0.022177645936608315,-0.2763029932975769,-0.14917463064193726,0.03109828010201454,-0.2398781180381775,-0.20744478702545166,0.06536488234996796,0.20907622575759888,0.04555827006697655,0.23007147014141083,-0.1799958348274231,0.2240041345357895,0.20756256580352783,0.04948640614748001,0.17539459466934204,0.03198789060115814,-0.1670752316713333,-0.26889681816101074,-0.4328955113887787,0.2623192369937897,-0.04458607733249664,-0.06886027753353119,0.08699873834848404,0.23001831769943237,-0.28588375449180603,0.20238852500915527,-0.20465297996997833},{0.09668146818876266,0.14202241599559784,0.12177639454603195,0.23297186195850372,0.029867779463529587,-0.24242590367794037,0.060756370425224304,0.11285917460918427,-0.2665238380432129,0.2151343822479248,0.3658190369606018,0.08225345611572266,0.17267851531505585,-0.15087264776229858,-0.09756624698638916,-0.31683313846588135,0.09862973541021347,0.2930828034877777,0.28271719813346863,0.046802230179309845,-0.4349989593029022,-0.18983444571495056,0.2589588761329651,0.17266090214252472,-0.20567640662193298,-0.24351225793361664,0.07859834283590317,0.2508249282836914,0.30408012866973877,0.2902049422264099,-0.09923471510410309,0.0009251608862541616},{-0.14284752309322357,0.12201455235481262,-0.23715288937091827,-0.1407192498445511,-0.33481478691101074,0.11593034118413925,-0.31464385986328125,-0.19218890368938446,0.1774899959564209,-0.11155359447002411,-0.22507111728191376,0.16705192625522614,-0.34920793771743774,-0.010529104620218277,0.07983516901731491,0.07294964790344238,0.13361790776252747,-0.22566422820091248,0.091339111328125,-0.22998109459877014,0.03610004112124443,0.2941983640193939,0.2117692083120346,0.029229778796434402,-0.2273835688829422,-0.3088407814502716,-0.19120153784751892,-0.1681528240442276,-0.11290839314460754,0.1274111270904541,0.316410630941391,-0.33277830481529236},{-0.1107804924249649,0.23852021992206573,-0.2879354953765869,0.25541412830352783,0.20861521363258362,-0.18761512637138367,0.2149103432893753,0.18678046762943268,-0.15980668365955353,0.2720472812652588,0.13631361722946167,-0.16068695485591888,0.10270462930202484,-0.2355310171842575,0.22117458283901215,0.0910179391503334,-0.02440265566110611,0.1590481698513031,-0.16824665665626526,-0.2806697189807892,0.301738440990448,0.3279136121273041,0.10356230288743973,0.05328742787241936,-0.15619657933712006,-0.24607935547828674,0.005797984078526497,0.09557536989450455,-0.27483776211738586,-0.15023492276668549,-0.20649833977222443,-0.12009554356336594},{-0.419185072183609,0.11382409930229187,-0.2200089544057846,0.1562475860118866,0.1774778962135315,-0.2441856861114502,0.1723504513502121,-0.05035054311156273,-0.12720878422260284,0.08097705990076065,0.23784801363945007,0.04121159017086029,-0.10242483764886856,0.10478851199150085,0.08306767046451569,-0.15956246852874756,-0.2577880024909973,-0.06563156098127365,-0.003175328718498349,0.272349089384079,0.25668665766716003,-0.0008991577778942883,0.10396772623062134,-0.46025148034095764,-0.018849654123187065,-0.16150465607643127,0.13078486919403076,0.18806584179401398,0.025495896115899086,-0.014382797293365002,0.039299316704273224,-0.020387299358844757},{0.28883615136146545,-0.08054202795028687,0.2977519631385803,0.24483923614025116,0.2091829478740692,0.28543728590011597,0.1307728886604309,0.27497389912605286,-0.3745504915714264,-0.11864721029996872,-0.4013844430446625,0.17916138470172882,0.19877207279205322,-0.21259281039237976,0.304539293050766,-0.1677410751581192,0.12731458246707916,0.09893004596233368,-0.01087160874158144,0.1669335663318634,-0.06087042763829231,-0.6205845475196838,-0.460102915763855,0.21124732494354248,-0.04522096365690231,-0.03680378943681717,-0.21596793830394745,0.010043483227491379,0.057722751051187515,-0.13907165825366974,-0.22672384977340698,0.3770545423030853},{-0.235789492726326,-0.09988254308700562,-0.053001515567302704,-0.0649382546544075,-0.2512640953063965,-0.20068955421447754,0.11120672523975372,-0.27390047907829285,-0.32000043988227844,-0.11405253410339355,-0.013772046193480492,0.4476132392883301,0.30372950434684753,-0.10061276704072952,0.2622428834438324,0.1132550910115242,-0.6254047751426697,0.1377324014902115,0.3569447696208954,0.14168481528759003,0.40195053815841675,0.04545876383781433,-0.28760501742362976,0.20960015058517456,-0.1617029756307602,0.09392224252223969,-0.18524567782878876,0.05031467229127884,0.0565335713326931,0.4043262004852295,-0.4687512218952179,-0.14419758319854736},{-0.08173447847366333,0.06408723443746567,0.1219540536403656,-0.2818630635738373,-0.37290751934051514,-0.20010997354984283,0.05603597313165665,-0.05464755743741989,-0.14642442762851715,0.0393388532102108,0.16720464825630188,-0.4719623923301697,-0.0861462652683258,-0.2675432562828064,-0.019429171457886696,0.013571059331297874,-0.14702102541923523,-0.2657482922077179,-0.007496689911931753,0.28251010179519653,-0.33615800738334656,0.1577984243631363,0.03258192911744118,-0.4242349863052368,0.1199745237827301,-0.20997507870197296,-0.026591314002871513,-0.17696478962898254,-0.009291586466133595,0.1775422990322113,-0.17433936893939972,0.06679799407720566},{-0.0971975103020668,0.07907099276781082,-0.03250758722424507,0.052813414484262466,0.11109267920255661,0.22146089375019073,-0.019218280911445618,0.27081260085105896,0.11282452940940857,0.21521718800067902,0.09643056243658066,0.0695788711309433,0.261176198720932,-0.15551842749118805,-0.24236823618412018,0.032604292035102844,0.1993306577205658,-0.006699983961880207,-0.0013692608335986733,-0.20019076764583588,0.1701645702123642,-0.07705356925725937,0.379851371049881,0.15397502481937408,-0.19802680611610413,-0.34043705463409424,-0.004417869728058577,0.07733853161334991,0.3067278563976288,0.008135421201586723,-0.2089671492576599,0.029983993619680405},{-0.17108528316020966,-0.03252822160720825,-0.11146195977926254,0.047875985503196716,0.051814399659633636,0.10645533353090286,0.13381479680538177,0.1060408279299736,-0.16721265017986298,-0.01956997811794281,0.35069894790649414,-0.3830031454563141,0.3352571427822113,-0.22027583420276642,-0.042419154196977615,0.06618141382932663,-0.12773911654949188,-0.2680606245994568,0.21443243324756622,-0.0970536321401596,-0.29004448652267456,0.10082127898931503,0.22963373363018036,-0.28928470611572266,0.35226142406463623,0.33959823846817017,-0.22058336436748505,-0.16737274825572968,-0.05081990733742714,-0.2247304916381836,-0.018495341762900352,-0.28178703784942627},{0.05740208551287651,-0.16712859272956848,-0.05105634778738022,-0.12320759892463684,-0.23504053056240082,0.19471894204616547,-0.2539609372615814,0.024852069094777107,0.2830396592617035,-0.3591771125793457,0.24660001695156097,-0.07320775836706161,0.5178455710411072,0.2665463089942932,0.5803540945053101,-0.1120736300945282,0.20260366797447205,-0.26603949069976807,0.4363527297973633,0.1336108297109604,-0.005357230547815561,-0.12590976059436798,0.15047794580459595,0.20562902092933655,0.10846716910600662,-0.15205059945583344,-0.15203195810317993,0.10898473858833313,-0.06729740649461746,0.011947772465646267,-0.059255652129650116,0.26938045024871826},{-0.22752977907657623,0.35347530245780945,0.0036718316841870546,-0.2559395730495453,-0.1031159833073616,-0.22353540360927582,-0.16865022480487823,-0.0984094887971878,0.33782073855400085,-0.042049258947372437,0.23636503517627716,0.10575500130653381,0.18735092878341675,-0.2718420624732971,0.1005963683128357,-0.22357802093029022,-0.16866283118724823,-0.17454548180103302,0.17859932780265808,-0.06161439046263695,0.10794858634471893,-0.07609782367944717,0.010596265085041523,0.08265284448862076,0.20394259691238403,-0.220977783203125,-0.4545348286628723,0.12983015179634094,0.14493247866630554,0.04716407135128975,-0.18633484840393066,0.20164930820465088}};
static const float action_parameterization_distribution_linear_weight[32][4] = {{0.33287912607192993,0.3089514672756195,0.23761995136737823,0.42428502440452576},{-0.12761789560317993,-0.010125232860445976,-0.17292554676532745,-0.36837419867515564},{0.09182613343000412,-0.34827256202697754,0.43887796998023987,0.3213517367839813},{0.21190258860588074,0.0949959009885788,-0.09962159395217896,-0.014727406203746796},{0.39174291491508484,-0.16290442645549774,-0.10108654946088791,-0.39611712098121643},{-0.3106516897678375,0.015528790652751923,-0.08091086894273758,-0.3261983394622803},{-0.26845210790634155,-0.021894628182053566,0.19651436805725098,-0.10873331129550934},{-0.18195094168186188,-0.3648558259010315,0.38830170035362244,-0.2790548503398895},{-0.017401138320565224,-0.18607617914676666,0.013762425631284714,0.363982230424881},{-0.00381561741232872,0.04986211657524109,0.32602718472480774,0.34144723415374756},{-0.18451081216335297,0.3040043115615845,-0.4577037990093231,0.05761324241757393},{0.2182527780532837,-0.011790983378887177,-0.3590364456176758,0.08067932724952698},{0.006129254586994648,-0.3854748606681824,-0.20230288803577423,0.25264278054237366},{0.3296622037887573,0.23259523510932922,-0.00611663656309247,-0.3598611056804657},{-0.03609449788928032,-0.4366310238838196,-0.45153144001960754,-0.08959060907363892},{0.5149461030960083,0.4051748216152191,0.04795214906334877,-0.30027925968170166},{-0.13688220083713531,-0.06475560367107391,0.27381882071495056,0.18467460572719574},{-0.39792606234550476,-0.2014451026916504,-0.05903308838605881,0.40854981541633606},{-0.14490249752998352,-0.450512170791626,-0.11097662150859833,-0.19629155099391937},{0.3986873924732208,0.32311293482780457,0.18289735913276672,0.18712815642356873},{0.4456843435764313,0.13310371339321136,-0.2010556161403656,-0.29223066568374634},{-0.1420169174671173,0.189381405711174,0.25848278403282166,-0.40904855728149414},{-0.19272863864898682,0.22065921127796173,-0.04235709086060524,0.026020200923085213},{0.04418964311480522,-0.19320660829544067,0.2680927813053131,0.19385074079036713},{-0.08470498770475388,-0.27413779497146606,0.3659108877182007,0.17294850945472717},{-0.05605360493063927,-0.3451455533504486,0.3033170700073242,0.0977078527212143},{0.15850064158439636,0.12441091984510422,0.292538583278656,-0.03524566441774368},{-0.3071979582309723,0.03711661323904991,0.09207217395305634,-0.06238957494497299},{-0.3367367386817932,-0.29392001032829285,-0.003583895741030574,0.19964811205863953},{-0.11823700368404388,-0.31178683042526245,-0.24949553608894348,-0.2463536262512207},{-0.22694458067417145,0.19205452501773834,0.37951675057411194,-0.35358184576034546},{0.30078160762786865,0.11674173176288605,-0.07150058448314667,0.22995300590991974}};

static const float actor_encoder_neighbor_encoder_embedding_mlp_0_bias[8] = {0.09054089337587357,0.15199235081672668,-0.11657754331827164,0.021963154897093773,0.21147382259368896,0.034715186804533005,0.10801771283149719,0.14744867384433746};
static const float actor_encoder_neighbor_encoder_embedding_mlp_2_bias[8] = {0.20881527662277222,0.24426570534706116,0.27795931696891785,0.14956460893154144,-0.014420254155993462,0.11806763708591461,0.18756170570850372,0.2690894603729248};

static const float actor_encoder_self_encoder_0_bias[16] = {0.22763897478580475,0.03450649231672287,0.2540818154811859,-0.22258561849594116,0.1145186722278595,0.06184278428554535,0.1488221287727356,0.21545259654521942,-0.16188707947731018,0.11018897593021393,0.22769995033740997,0.38630837202072144,0.21622708439826965,0.05954987555742264,0.14636629819869995,0.17195001244544983};
static const float actor_encoder_self_encoder_2_bias[16] = {0.11278434842824936,0.0906004086136818,0.012021685019135475,0.03997240215539932,0.1909482628107071,0.1306123584508896,-0.010342543013393879,0.0697697103023529,0.1582934856414795,-0.11456869542598724,0.06546904146671295,0.04913822188973427,0.09403806179761887,0.2372099608182907,0.0860084742307663,0.08752262592315674};

static const float actor_encoder_feed_forward_0_bias[32] = {0.0354200154542923,0.042984649538993835,-0.049426812678575516,-0.042806658893823624,-0.13451990485191345,-0.03357531130313873,-0.055147573351860046,-0.028108185157179832,-0.059874746948480606,-0.04978301748633385,0.19132012128829956,-0.0012429456692188978,0.13434217870235443,-0.053520843386650085,0.11479896306991577,0.07518072426319122,-0.06083989888429642,-0.0022931769490242004,-0.02801239863038063,0.035718224942684174,0.04469266161322594,-0.025806207209825516,0.08251718431711197,-0.221547931432724,-0.04240749031305313,-0.005646929610520601,-0.0749375969171524,-0.09083469212055206,0.057736463844776154,-0.05463701859116554,-0.05452791601419449,0.12896470725536346};

static const float action_parameterization_distribution_linear_bias[4] = {-0.0032787735108286142,0.09838566929101944,-0.19764924049377441,0.1253713071346283};





void networkEvaluate(struct control_t_n *control_n, const float *state_array) {

  
      ///////////////////////////////// NEIGHBOR OUTPUT CALCULATION ///////////////////////////////////////////
      float meanNeighbArr[8];
      meanNeighbArr[0] = 0.0f;
      meanNeighbArr[1] = 0.0f;
      meanNeighbArr[2] = 0.0f;
      meanNeighbArr[3] = 0.0f;
      meanNeighbArr[4] = 0.0f;
      meanNeighbArr[5] = 0.0f;
      meanNeighbArr[6] = 0.0f;
      meanNeighbArr[7] = 0.0f;

        for(int k = 0; k < NEIGHBORS; k++)
        {
          for (int i = 0; i < structure[0][1]; i++) {
              output_0[i] = 0;
              for (int j = 0; j < structure[0][0]; j++) {
                output_0[i] += kNearestArr[k][j] * actor_encoder_neighbor_encoder_embedding_mlp_0_weight[j][i];
              }
              output_0[i] += actor_encoder_neighbor_encoder_embedding_mlp_0_bias[i];
              output_0[i] = relu(output_0[i]);
          }
      
          for (int i = 0; i < structure[1][1]; i++) {
              output_1[i] = 0;
              for (int j = 0; j < structure[1][0]; j++) {
                  output_1[i] += output_0[j] * actor_encoder_neighbor_encoder_embedding_mlp_2_weight[j][i];
              }
              output_1[i] += actor_encoder_neighbor_encoder_embedding_mlp_2_bias[i];
              output_1[i] = relu(output_1[i]);

          }


          meanNeighbArr[0] = meanNeighbArr[0]+output_1[0];
          meanNeighbArr[1] = meanNeighbArr[1]+output_1[1];
          meanNeighbArr[2] = meanNeighbArr[2]+output_1[2];
          meanNeighbArr[3] = meanNeighbArr[3]+output_1[3];
          meanNeighbArr[4] = meanNeighbArr[4]+output_1[4];
          meanNeighbArr[5] = meanNeighbArr[5]+output_1[5];
          meanNeighbArr[6] = meanNeighbArr[6]+output_1[6];
          meanNeighbArr[7] = meanNeighbArr[7]+output_1[7];


        } 

        meanNeighbArr[0] /= NEIGHBORS;
        meanNeighbArr[1] /= NEIGHBORS;
        meanNeighbArr[2] /= NEIGHBORS;
        meanNeighbArr[3] /= NEIGHBORS;
        meanNeighbArr[4] /= NEIGHBORS;
        meanNeighbArr[5] /= NEIGHBORS;
        meanNeighbArr[6] /= NEIGHBORS;
        meanNeighbArr[7] /= NEIGHBORS;

          /////////////////// SELF_OUTPUT ///////////////////////////////////////////////////////////////////
          for (int i = 0; i < structure[2][1]; i++) {
              output_2[i] = 0;
              for (int j = 0; j < structure[2][0]; j++) {
                  output_2[i] += state_array[j] * actor_encoder_self_encoder_0_weight[j][i];
              }
              output_2[i] += actor_encoder_self_encoder_0_bias[i];
              //output_2[i] = tanhf(output_2[i]);
              output_2[i] = relu(output_2[i]);

          }
          
          for (int i = 0; i < structure[3][1]; i++) {
              output_3[i] = 0;
              for (int j = 0; j < structure[3][0]; j++) {
                  output_3[i] += output_2[j] * actor_encoder_self_encoder_2_weight[j][i];
              }
              output_3[i] += actor_encoder_self_encoder_2_bias[i];
              //output_3[i] = tanhf(output_3[i]);
              output_3[i] = relu(output_3[i]);

          }
          

          ////////////////////////////////////////////////////// FEED FORWARD /////////////////////////////////////////////

          for(int k = 0; k < structure[3][1]; k++ )
          {
            inputff[k] = output_3[k];
          }

          for(int k = 0; k < structure[1][1]; k++ )
          {
            inputff[k+16] = meanNeighbArr[k];
          }

          for (int i = 0; i < structure[4][1]; i++) {
              output_4[i] = 0;
              for (int j = 0; j < structure[4][0]; j++) {
                  output_4[i] += inputff[j] * actor_encoder_feed_forward_0_weight[j][i];
              }
              output_4[i] += actor_encoder_feed_forward_0_bias[i];
              //output_4[i] = tanhf(output_4[i]);
              output_4[i] = relu(output_4[i]);

          }
          
          for (int i = 0; i < structure[5][1]; i++) {
              output_5[i] = 0;
              for (int j = 0; j < structure[5][0]; j++) {
                  output_5[i] += output_4[j] * action_parameterization_distribution_linear_weight[j][i];
              }
              output_5[i] += action_parameterization_distribution_linear_bias[i];
          }
        control_n->thrust_0 = output_5[0];
        control_n->thrust_1 = output_5[1];
        control_n->thrust_2 = output_5[2];
        control_n->thrust_3 = output_5[3];	
    }

int main_nn(float *outdatav)
{
    control_t_n motorThrusts;
    
    point_t pt;
    estimatorKalmanGetEstimatedPos(&pt);

    ///////////////////////////////////////////// update k nearest information
    float ownX = pt.x;
    float ownY = pt.y;
    float ownZ = pt.z;

    float farX = kNearestArr[farthestNeighb][0];
    float farY = kNearestArr[farthestNeighb][1];
    float farZ = kNearestArr[farthestNeighb][2];

    float lastX = dronesInfo[lastAdded][0];
    float lastY = dronesInfo[lastAdded][1];
    float lastZ = dronesInfo[lastAdded][2];

    float distFarX = (farX-ownX)*(farX-ownX);
    float distFarY = (farY-ownY)*(farY-ownY);
    float distFarZ = (farZ-ownZ)*(farZ-ownZ);

    float distLastX = (lastX-ownX)*(lastX-ownX);
    float distLastY = (lastY-ownY)*(lastY-ownY);
    float distLastZ = (lastZ-ownZ)*(lastZ-ownZ);

    float distFar  = sqrtf(distFarX  + distFarY  + distFarZ);
    float distLast = sqrtf(distLastX + distLastY + distLastZ);



    if(distLast < distFar) // if last added information is closer than farthest k nearest neighbor, update
    {

      // update infrmation
      kNearestArr[farthestNeighb][0] = dronesInfo[farthestNeighb][0];
      kNearestArr[farthestNeighb][1] = dronesInfo[farthestNeighb][1];
      kNearestArr[farthestNeighb][2] = dronesInfo[farthestNeighb][2];

      farthestNeighb = 0; // set new farthest neighbor to calcuate index of farthest neighbor

      // calculate distance to k nearest at index 0
      farX = kNearestArr[farthestNeighb][0];
      farY = kNearestArr[farthestNeighb][1];
      farZ = kNearestArr[farthestNeighb][2];

      distFarX = (farX-ownX)*(farX-ownX);
      distFarY = (farY-ownY)*(farY-ownY);
      distFarZ = (farZ-ownZ)*(farZ-ownZ);

      distFar  = sqrtf(distFarX  + distFarY  + distFarZ);

      for(int k = 1; k < NEIGHBORS; k++) // iteratio over all k nearest to compare distance
      {
        if(distFar < sqrtf((kNearestArr[k][0]-ownX)*(kNearestArr[k][0]-ownX)  + 
                           (kNearestArr[k][1]-ownY)*(kNearestArr[k][1]-ownY)  + 
                           (kNearestArr[k][2]-ownZ)*(kNearestArr[k][2]-ownZ))) // if k is nearest than farthest, change farthest
        {
          farthestNeighb = k;

          farX = kNearestArr[farthestNeighb][0];
          farY = kNearestArr[farthestNeighb][1];
          farZ = kNearestArr[farthestNeighb][2];

          distFarX = (farX-ownX)*(farX-ownX);
          distFarY = (farY-ownY)*(farY-ownY);
          distFarZ = (farZ-ownZ)*(farZ-ownZ);

          distFar  = sqrtf(distFarX  + distFarY  + distFarZ);

        }
        
      }

    }

  
  for(int k = 0; k < NGHBRS; k++)
  {
    kNearestArr[k][0] =  clip(kNearestArr[k][0], -10.0f, 10.0f);
    kNearestArr[k][1] =  clip(kNearestArr[k][1], -10.0f, 10.0f);
    kNearestArr[k][2] =  clip(kNearestArr[k][2], -10.0f, 10.0f);

    kNearestArr[k][0] =  clip(kNearestArr[k][0], -40.0f, 40.0f);
    kNearestArr[k][1] =  clip(kNearestArr[k][1], -40.0f, 40.0f);
    kNearestArr[k][2] =  clip(kNearestArr[k][2], -40.0f, 40.0f);


  }
  //////////////////////////////////////////////////////// get self information
  state_t ownState = getOwnState();

    // Orientation
	struct quat q = mkquat(ownState.attitudeQuaternion.x, 
						             ownState.attitudeQuaternion.y, 
						             ownState.attitudeQuaternion.z, 
						             ownState.attitudeQuaternion.w);

	rot = quat2rotmat(q);
  
	// angular velocity
  sensorData_t sensors = getSensorData();
	float omega_roll  = radians(sensors.gyro.x);
	float omega_pitch = radians(sensors.gyro.y);
	float omega_yaw   = radians(sensors.gyro.z);

	// the state vector
	state_array[0] = ownState.position.x - ownTarget[0];
	state_array[1] = ownState.position.y - ownTarget[1];
	state_array[2] = ownState.position.z - ownTarget[2];
	state_array[3] = ownState.velocity.x;
	state_array[4] = ownState.velocity.y;
	state_array[5] = ownState.velocity.z;
	state_array[6] = rot.m[0][0];
	state_array[7] = rot.m[0][1];
	state_array[8] = rot.m[0][2];
	state_array[9] = rot.m[1][0];
	state_array[10] = rot.m[1][1];
	state_array[11] = rot.m[1][2];
	state_array[12] = rot.m[2][0];
	state_array[13] = rot.m[2][1];
	state_array[14] = rot.m[2][2];
	state_array[15] = omega_roll;
	state_array[16] = omega_pitch;
	state_array[17] = omega_yaw;


state_array[0]  = clip(state_array[0] , -10.0f, 10.0f);
state_array[1]  = clip(state_array[1] , -10.0f, 10.0f);
state_array[2]  = clip(state_array[2] , -10.0f, 10.0f);
state_array[3]  = clip(state_array[3] , -3.0f, 3.0f);
state_array[4]  = clip(state_array[4] , -3.0f, 3.0f);
state_array[5]  = clip(state_array[5] , -3.0f, 3.0f);
state_array[6]  = clip(state_array[6] , -1.0f, 1.0f);
state_array[7]  = clip(state_array[7] , -1.0f, 1.0f);
state_array[8]  = clip(state_array[8] , -1.0f, 1.0f);
state_array[9]  = clip(state_array[9] , -1.0f, 1.0f);
state_array[10] = clip(state_array[10], -1.0f, 1.0f);
state_array[11] = clip(state_array[11], -1.0f, 1.0f);
state_array[12] = clip(state_array[12], -1.0f, 1.0f);
state_array[13] = clip(state_array[13], -1.0f, 1.0f);
state_array[14] = clip(state_array[14], -1.0f, 1.0f);
state_array[15] = clip(state_array[15], -40.0f, 40.0f);
state_array[16] = clip(state_array[16], -40.0f, 40.0f);
state_array[17] = clip(state_array[17], -40.0f, 40.0f);



  networkEvaluate(&motorThrusts, state_array);

  outdatav[0] = motorThrusts.thrust_0;
  outdatav[1] = motorThrusts.thrust_1;
  outdatav[2] = motorThrusts.thrust_2;
  outdatav[3] = motorThrusts.thrust_3;
    
  return 1;
}

float clip(float val, float min, float max)
{
  if(val < min)
      {
        return min;
      }
      else if(val > max)
      {
        return max;
      }
      else
      {
        return val;
      }
}



void communicate()
{
  if (timer == ownPacket.id)
  {
    ownPacket.pos = getPosition();
    ownPacket.vel = getVeloc();
    P2PPacket packet;
    packet.port = 0;
    packet.size = sizeof(PacketData);
    memcpy(packet.data, &ownPacket, sizeof(PacketData));
    radiolinkSendP2PPacketBroadcast(&packet);
  }
}

void p2pcallbackHandler(P2PPacket *p)
{
    PacketData received;
    memcpy(&received, p->data, sizeof(PacketData));
    lastAdded = received.id;
    
    dronesInfo[received.id][0] = received.pos.x;
    dronesInfo[received.id][1] = received.pos.x;
    dronesInfo[received.id][2] = received.pos.y;
    
    dronesInfo[received.id][3] = received.vel.x;
    dronesInfo[received.id][4] = received.vel.y;
    dronesInfo[received.id][5] = received.vel.z;

}


Vector3 getPosition(void)
{
    point_t pt;
    estimatorKalmanGetEstimatedPos(&pt);
    return (Vector3){.x = pt.x, .y=pt.y, .z=pt.z};
} 

Vector3 getVeloc(void)
{
    return getVelocity();
}

uint8_t isHighLevel()
{
  return highlvl;

}

void  getThrusts(uint16_t* trsts)
{
  trsts[0] = thrustsToMotor[1];
  trsts[1] = thrustsToMotor[2];
  trsts[2] = thrustsToMotor[3];
  trsts[3] = thrustsToMotor[0];
}

void appMain() { 
  	// control->enableDirectThrust = true; // in the code of quadswarms they use this, why? (seems they changed the firmware)
  vTaskDelay(M2T(10000));
  p2pRegisterCB(p2pcallbackHandler);

  uint64_t address = configblockGetRadioAddress();
  uint8_t my_id    = (uint8_t)((address) & 0x00000000ff);
  ownPacket.id     = my_id;
  point_t ownPosition;
  estimatorKalmanGetEstimatedPos(&ownPosition);

  Vector3 ownVeloc = getVeloc();

  for(int k = 0; k < NUMQUADS; k++)
  {
    dronesInfo[k][0] =  8.0f;
    dronesInfo[k][1] =  k*1.5f;
    dronesInfo[k][2] =  0.0f;

    dronesInfo[k][3] = 0.0f;
    dronesInfo[k][4] = 0.0f;
    dronesInfo[k][5] = 0.0f;

  }
  
  for(int k = 0; k < NGHBRS; k++)
  {
    kNearestArr[k][0]  = ownPosition.x - dronesInfo[k][0];
    kNearestArr[k][1]  = ownPosition.y - dronesInfo[k][1];
    kNearestArr[k][2]  = ownPosition.z - dronesInfo[k][2];

    kNearestArr[k][3]  = ownVeloc.x;
    kNearestArr[k][4]  = ownVeloc.y;
    kNearestArr[k][5]  = ownVeloc.z;
  }
    

  while(1) {

    vTaskDelay(M2T(1));
    estimatorKalmanGetEstimatedPos(&ownPosition);
    //communicate();
    timer++;
    if(timer >= NUMQUADS)
    {
      timer = 0;
    }

    switch (state)
    {
    case 0: // do nothing
      break;
    case 1: // start 
            
      // for(int k = 0; k < 4; k++)
      // {
      //   thrustsToMotor[k] = (uint16_t)(UINT16_MAX*thrusts[k]*(mototrKValue));
      // }
      motorsSetRatio(0, thrusts[1]);
      motorsSetRatio(1, thrusts[2]);
      motorsSetRatio(2, thrusts[3]);
      motorsSetRatio(3, thrusts[0]);

      break;
    case 2: // land

      if(ownPosition.z < 0.15f)
      {
        for(int k = 0; k < 4; k++)
        {
            thrustsToMotor[k] = (uint16_t)(UINT16_MAX*(0.0f));
        }
        state = 0;
      }
      break;
    default:
      break;
    }
    main_nn(thrusts);
    
    for(int k = 0; k < 4; k++)
    {
      if(thrusts[k] < -1.0f)
      {
        thrusts[k] = -1.0f;
      }
      else if(thrusts[k] > 1.0f)
      {
        thrusts[k] = 1.0f;
      }

      thrusts[k] += 1.0f;
      thrusts[k] /= 2.0f;

    }

  }
}



PARAM_GROUP_START(ctrlnn)
PARAM_ADD(PARAM_UINT8, stt,    &state)
PARAM_ADD(PARAM_UINT8, id,     &(ownPacket.id))
PARAM_ADD(PARAM_FLOAT, kVal, &mototrKValue)
PARAM_GROUP_STOP(ctrlnn)

LOG_GROUP_START(logNN)         
LOG_ADD(LOG_INT16, id, &(ownPacket.id))

LOG_ADD(LOG_FLOAT, t0, &(thrusts[0]))
LOG_ADD(LOG_FLOAT, t1, &(thrusts[1]))
LOG_ADD(LOG_FLOAT, t2, &(thrusts[2]))
LOG_ADD(LOG_FLOAT, t3, &(thrusts[3]))

LOG_ADD(LOG_FLOAT, px, &(state_array[0]))
LOG_ADD(LOG_FLOAT, py, &(state_array[1]))
LOG_ADD(LOG_FLOAT, pz, &(state_array[2]))
LOG_ADD(LOG_FLOAT, vx, &(state_array[3]))
LOG_ADD(LOG_FLOAT, vy, &(state_array[4]))
LOG_ADD(LOG_FLOAT, vz, &(state_array[5]))

LOG_ADD(LOG_FLOAT, r0, &(state_array[7]))
LOG_ADD(LOG_FLOAT, r1, &(state_array[8]))
LOG_ADD(LOG_FLOAT, r2, &(state_array[9]))
LOG_ADD(LOG_FLOAT, r3, &(state_array[10]))
LOG_ADD(LOG_FLOAT, r4, &(state_array[6]))
LOG_ADD(LOG_FLOAT, r5, &(state_array[11]))
LOG_ADD(LOG_FLOAT, r6, &(state_array[12]))
LOG_ADD(LOG_FLOAT, r7, &(state_array[13]))
LOG_ADD(LOG_FLOAT, r8, &(state_array[14]))

LOG_ADD(LOG_FLOAT, wx, &(state_array[15]))
LOG_ADD(LOG_FLOAT, wy, &(state_array[16]))
LOG_ADD(LOG_FLOAT, wz, &(state_array[17]))

LOG_ADD(LOG_FLOAT, px0, &(kNearestArr[0][0]))
LOG_ADD(LOG_FLOAT, py0, &(kNearestArr[0][1]))
LOG_ADD(LOG_FLOAT, pz0, &(kNearestArr[0][2]))
LOG_ADD(LOG_FLOAT, vx0, &(kNearestArr[0][3]))
LOG_ADD(LOG_FLOAT, vy0, &(kNearestArr[0][4]))
LOG_ADD(LOG_FLOAT, vz0, &(kNearestArr[0][5]))

LOG_ADD(LOG_FLOAT, px1, &(kNearestArr[1][0]))
LOG_ADD(LOG_FLOAT, py1, &(kNearestArr[1][1]))
LOG_ADD(LOG_FLOAT, pz1, &(kNearestArr[1][2]))
LOG_ADD(LOG_FLOAT, vx1, &(kNearestArr[1][3]))
LOG_ADD(LOG_FLOAT, vy1, &(kNearestArr[1][4]))
LOG_ADD(LOG_FLOAT, vz1, &(kNearestArr[1][5]))

LOG_ADD(LOG_FLOAT, px2, &(kNearestArr[2][0]))
LOG_ADD(LOG_FLOAT, py2, &(kNearestArr[2][1]))
LOG_ADD(LOG_FLOAT, pz2, &(kNearestArr[2][2]))
LOG_ADD(LOG_FLOAT, vx2, &(kNearestArr[2][3]))
LOG_ADD(LOG_FLOAT, vy2, &(kNearestArr[2][4]))
LOG_ADD(LOG_FLOAT, vz2, &(kNearestArr[2][5]))

LOG_ADD(LOG_FLOAT, px3, &(kNearestArr[3][0]))
LOG_ADD(LOG_FLOAT, py3, &(kNearestArr[3][1]))
LOG_ADD(LOG_FLOAT, pz3, &(kNearestArr[3][2]))
LOG_ADD(LOG_FLOAT, vx3, &(kNearestArr[3][3]))
LOG_ADD(LOG_FLOAT, vy3, &(kNearestArr[3][4]))
LOG_ADD(LOG_FLOAT, vz3, &(kNearestArr[3][5]))

LOG_ADD(LOG_FLOAT, px4, &(kNearestArr[4][0]))
LOG_ADD(LOG_FLOAT, py4, &(kNearestArr[4][1]))
LOG_ADD(LOG_FLOAT, pz4, &(kNearestArr[4][2]))
LOG_ADD(LOG_FLOAT, vx4, &(kNearestArr[4][3]))
LOG_ADD(LOG_FLOAT, vy4, &(kNearestArr[4][4]))
LOG_ADD(LOG_FLOAT, vz4, &(kNearestArr[4][5]))

LOG_ADD(LOG_FLOAT, px5, &(kNearestArr[5][0]))
LOG_ADD(LOG_FLOAT, py5, &(kNearestArr[5][1]))
LOG_ADD(LOG_FLOAT, pz5, &(kNearestArr[5][2]))
LOG_ADD(LOG_FLOAT, vx5, &(kNearestArr[5][3]))
LOG_ADD(LOG_FLOAT, vy5, &(kNearestArr[5][4]))
LOG_ADD(LOG_FLOAT, vz5, &(kNearestArr[5][5]))

LOG_ADD(LOG_FLOAT, targetx, &(ownTarget[0]))
LOG_ADD(LOG_FLOAT, targety, &(ownTarget[1]))
LOG_ADD(LOG_FLOAT, targetz, &(ownTarget[2]))

LOG_ADD(LOG_FLOAT, out0_0, &(output_0[0]))
LOG_ADD(LOG_FLOAT, out0_1, &(output_0[1]))
LOG_ADD(LOG_FLOAT, out0_2, &(output_0[2]))
LOG_ADD(LOG_FLOAT, out0_3, &(output_0[3]))
LOG_ADD(LOG_FLOAT, out0_4, &(output_0[4]))
LOG_ADD(LOG_FLOAT, out0_5, &(output_0[5]))
LOG_ADD(LOG_FLOAT, out0_6, &(output_0[6]))
LOG_ADD(LOG_FLOAT, out0_7, &(output_0[7]))

LOG_ADD(LOG_FLOAT, out1_0, &(output_1[0]))
LOG_ADD(LOG_FLOAT, out1_1, &(output_1[1]))
LOG_ADD(LOG_FLOAT, out1_2, &(output_1[2]))
LOG_ADD(LOG_FLOAT, out1_3, &(output_1[3]))
LOG_ADD(LOG_FLOAT, out1_4, &(output_1[4]))
LOG_ADD(LOG_FLOAT, out1_5, &(output_1[5]))
LOG_ADD(LOG_FLOAT, out1_6, &(output_1[6]))
LOG_ADD(LOG_FLOAT, out1_7, &(output_1[7]))

LOG_ADD(LOG_FLOAT, out2_0, &(output_2[0]))
LOG_ADD(LOG_FLOAT, out2_1, &(output_2[1]))
LOG_ADD(LOG_FLOAT, out2_2, &(output_2[2]))
LOG_ADD(LOG_FLOAT, out2_3, &(output_2[3]))
LOG_ADD(LOG_FLOAT, out2_4, &(output_2[4]))
LOG_ADD(LOG_FLOAT, out2_5, &(output_2[5]))
LOG_ADD(LOG_FLOAT, out2_6, &(output_2[6]))
LOG_ADD(LOG_FLOAT, out2_7, &(output_2[7]))
LOG_ADD(LOG_FLOAT, out2_8, &(output_2[8]))
LOG_ADD(LOG_FLOAT, out2_9, &(output_2[9]))
LOG_ADD(LOG_FLOAT, out2_10, &(output_2[10]))
LOG_ADD(LOG_FLOAT, out2_11, &(output_2[11]))
LOG_ADD(LOG_FLOAT, out2_12, &(output_2[12]))
LOG_ADD(LOG_FLOAT, out2_13, &(output_2[13]))
LOG_ADD(LOG_FLOAT, out2_14, &(output_2[14]))
LOG_ADD(LOG_FLOAT, out2_15, &(output_2[15]))

LOG_ADD(LOG_FLOAT, out3_0, &(output_3[0]))
LOG_ADD(LOG_FLOAT, out3_1, &(output_3[1]))
LOG_ADD(LOG_FLOAT, out3_2, &(output_3[2]))
LOG_ADD(LOG_FLOAT, out3_3, &(output_3[3]))
LOG_ADD(LOG_FLOAT, out3_4, &(output_3[4]))
LOG_ADD(LOG_FLOAT, out3_5, &(output_3[5]))
LOG_ADD(LOG_FLOAT, out3_6, &(output_3[6]))
LOG_ADD(LOG_FLOAT, out3_7, &(output_3[7]))
LOG_ADD(LOG_FLOAT, out3_8, &(output_3[8]))
LOG_ADD(LOG_FLOAT, out3_9, &(output_3[9]))
LOG_ADD(LOG_FLOAT, out3_10, &(output_3[10]))
LOG_ADD(LOG_FLOAT, out3_11, &(output_3[11]))
LOG_ADD(LOG_FLOAT, out3_12, &(output_3[12]))
LOG_ADD(LOG_FLOAT, out3_13, &(output_3[13]))
LOG_ADD(LOG_FLOAT, out3_14, &(output_3[14]))
LOG_ADD(LOG_FLOAT, out3_15, &(output_3[15]))

LOG_ADD(LOG_FLOAT, out4_0,    &(output_4[0]))
LOG_ADD(LOG_FLOAT, out4_1,    &(output_4[1]))
LOG_ADD(LOG_FLOAT, out4_2,    &(output_4[2]))
LOG_ADD(LOG_FLOAT, out4_3,    &(output_4[3]))
LOG_ADD(LOG_FLOAT, out4_4,    &(output_4[4]))
LOG_ADD(LOG_FLOAT, out4_5,    &(output_4[5]))
LOG_ADD(LOG_FLOAT, out4_6,    &(output_4[6]))
LOG_ADD(LOG_FLOAT, out4_7,    &(output_4[7]))
LOG_ADD(LOG_FLOAT, out4_8,    &(output_4[8]))
LOG_ADD(LOG_FLOAT, out4_9,    &(output_4[9]))
LOG_ADD(LOG_FLOAT, out4_10,   &(output_4[10]))
LOG_ADD(LOG_FLOAT, out4_11,   &(output_4[11]))
LOG_ADD(LOG_FLOAT, out4_12,   &(output_4[12]))
LOG_ADD(LOG_FLOAT, out4_13,   &(output_4[13]))
LOG_ADD(LOG_FLOAT, out4_14,   &(output_4[14]))
LOG_ADD(LOG_FLOAT, out4_15,   &(output_4[15]))
LOG_ADD(LOG_FLOAT, out4_16,   &(output_4[16]))
LOG_ADD(LOG_FLOAT, out4_17,   &(output_4[17]))
LOG_ADD(LOG_FLOAT, out4_18,   &(output_4[18]))
LOG_ADD(LOG_FLOAT, out4_19,   &(output_4[19]))
LOG_ADD(LOG_FLOAT, out4_20,   &(output_4[20]))
LOG_ADD(LOG_FLOAT, out4_21,   &(output_4[21]))
LOG_ADD(LOG_FLOAT, out4_22,   &(output_4[22]))
LOG_ADD(LOG_FLOAT, out4_23,   &(output_4[23]))
LOG_ADD(LOG_FLOAT, out4_4,    &(output_4[24]))
LOG_ADD(LOG_FLOAT, out4_5,    &(output_4[25]))
LOG_ADD(LOG_FLOAT, out4_6,    &(output_4[26]))
LOG_ADD(LOG_FLOAT, out4_7,    &(output_4[27]))
LOG_ADD(LOG_FLOAT, out4_8,    &(output_4[28]))
LOG_ADD(LOG_FLOAT, out4_9,    &(output_4[29]))
LOG_ADD(LOG_FLOAT, out4_10,   &(output_4[30]))
LOG_ADD(LOG_FLOAT, out4_11,   &(output_4[31]))

LOG_ADD(LOG_FLOAT, inputff_0,    &(inputff[0]))
LOG_ADD(LOG_FLOAT, inputff_1,    &(inputff[1]))
LOG_ADD(LOG_FLOAT, inputff_2,    &(inputff[2]))
LOG_ADD(LOG_FLOAT, inputff_3,    &(inputff[3]))
LOG_ADD(LOG_FLOAT, inputff_4,    &(inputff[4]))
LOG_ADD(LOG_FLOAT, inputff_5,    &(inputff[5]))
LOG_ADD(LOG_FLOAT, inputff_6,    &(inputff[6]))
LOG_ADD(LOG_FLOAT, inputff_7,    &(inputff[7]))
LOG_ADD(LOG_FLOAT, inputff_8,    &(inputff[8]))
LOG_ADD(LOG_FLOAT, inputff_9,    &(inputff[9]))
LOG_ADD(LOG_FLOAT, inputff_10,   &(inputff[10]))
LOG_ADD(LOG_FLOAT, inputff_11,   &(inputff[11]))
LOG_ADD(LOG_FLOAT, inputff_12,   &(inputff[12]))
LOG_ADD(LOG_FLOAT, inputff_13,   &(inputff[13]))
LOG_ADD(LOG_FLOAT, inputff_14,   &(inputff[14]))
LOG_ADD(LOG_FLOAT, inputff_15,   &(inputff[15]))
LOG_ADD(LOG_FLOAT, inputff_16,   &(inputff[16]))
LOG_ADD(LOG_FLOAT, inputff_17,   &(inputff[17]))
LOG_ADD(LOG_FLOAT, inputff_18,   &(inputff[18]))
LOG_ADD(LOG_FLOAT, inputff_19,   &(inputff[19]))
LOG_ADD(LOG_FLOAT, inputff_20,   &(inputff[20]))
LOG_ADD(LOG_FLOAT, inputff_21,   &(inputff[21]))
LOG_ADD(LOG_FLOAT, inputff_22,   &(inputff[22]))
LOG_ADD(LOG_FLOAT, inputff_23,   &(inputff[23]))


LOG_ADD(LOG_FLOAT, out5_0,  &(output_5[0]))
LOG_ADD(LOG_FLOAT, out5_1,  &(output_5[1]))
LOG_ADD(LOG_FLOAT, out5_2,  &(output_5[2]))
LOG_ADD(LOG_FLOAT, out5_3,  &(output_5[3]))

LOG_GROUP_STOP(logNN)



