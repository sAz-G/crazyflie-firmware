/**
 * ,---------,       ____  _ __
 * |  ,-^-,  |      / __ )(_) /_______________ _____  ___
 * | (  O  ) |     / __  / / __/ ___/ ___/ __ `/_  / / _ \
 * | / ,--Â´  |    / /_/ / / /_/ /__/ /  / /_/ / / /_/  __/
 *    +------`   /_____/_/\__/\___/_/   \__,_/ /___/\___/
 *
 * Crazyflie control firmware
 *
 * Copyright (C) 2019 Bitcraze AB
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, in version 3.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 *
 * hello_world.c - App layer application of a simple hello world debug print every
 *   2 seconds.
 */


#include <string.h>
#include <stdint.h>
#include <stdbool.h>

#include "app.h"

#include "FreeRTOS.h"
#include "task.h"

#include "debug.h"
#include "radiolink.h"
#include "param.h"
#include "log.h"
#include "configblock.h"
#include "stabilizer_types.h"
#include "commander.h"
#include "estimator_kalman.h"
#include "stabilizer.h"
#include "math3d.h"
#include "../include/coll_avoid_main.h"
#include "motors.h"

#define NGHBRS 6
#define NGHBRSDIM 6 
#define NDRNS 8


void networkEvaluate(control_t_n* control_n, const float* state_array);
int main_nn(float *outdatav);
Vector3 getPosition(void);
Vector3 getVeloc(void);
float clip(float val, float min, float max);

float linear(float num) {
	return num;
}


float sigmoid(float num) {
	return 1 / (1 + exp(-num));
}


float relu(float num) {
	if (num > 0) {
		return num;
	} else {
		return 0;
	}
}

static const int structure [6][2] = {{6, 8},{8, 8},{18, 16},{16, 16},{24, 32},{32, 4}};


static const int NEIGHBORS = NGHBRS;
static const int NBR_DIM = NGHBRSDIM; 
static const int NUMQUADS = NDRNS; 
static int farthestNeighb = 0;
static int lastAdded = 1;
static int timer = 0;
static PacketData ownPacket;
uint8_t highlvl = 0;

static float output_0[8];
static float output_1[8];
static float output_2[16];
static float output_3[16];
static float inputff[24];
static float output_4[32];
static float output_5[4];


static float mototrKValue = 1.0f;
static float thrusts[4]   = {0.f, 0.f, 0.f, 0.f};
static uint16_t thrustsInt[4];
static uint16_t thrustsToMotor[4];
static float dronesInfo[NDRNS][NGHBRSDIM];
static float kNearestArr[NGHBRS][NGHBRSDIM];
static float ownTarget[3] = {.0f, 0.f, .5f};
static struct mat33 rot;
static float state_array[18];
static int state = 0;

static const float actor_encoder_neighbor_encoder_embedding_mlp_0_weight[6][8]  = {{0.4817355275154114,-0.13560867309570312,-0.5717208981513977,-0.4451223611831665,-0.20544274151325226,0.9114608764648438,-0.09513801336288452,-0.432461142539978},{-0.3405008316040039,-0.8471822738647461,-0.2063400149345398,-0.3396919369697571,-0.03659500554203987,-0.7406834959983826,0.6632750034332275,0.0907977744936943},{0.22729414701461792,0.9578796029090881,0.16322074830532074,-0.960584819316864,0.1553315967321396,-0.12060192227363586,-0.15556170046329498,-0.4137076437473297},{0.03710112348198891,-0.3495730757713318,-0.7615658044815063,0.4963882863521576,-0.16626104712486267,0.29007843136787415,0.19772472977638245,0.1019504964351654},{0.000918674748390913,0.07690513879060745,-0.3546372354030609,0.4120495021343231,0.3575204312801361,0.09811306744813919,-0.014858439564704895,-0.016313539817929268},{0.04230943322181702,0.5551528334617615,-0.3784674406051636,0.18690985441207886,0.1466807723045349,0.36179810762405396,-0.7853116393089294,0.5242552161216736}};
static const float actor_encoder_neighbor_encoder_embedding_mlp_2_weight[8][8]  = {{-0.5959084630012512,0.537564218044281,0.23057174682617188,0.6393026113510132,0.14313368499279022,0.5566742420196533,0.21864642202854156,0.616031289100647},{-0.07711222022771835,0.528014063835144,-0.1280953288078308,-0.3708931803703308,-0.2840973436832428,-0.21220925450325012,-0.5873594284057617,0.14380255341529846},{-0.012332472018897533,-0.10992599278688431,-0.026796724647283554,-0.13250276446342468,-0.17291583120822906,-0.060947902500629425,0.3948761820793152,-0.382690966129303},{-0.016652826219797134,-0.6258770227432251,-0.3382711410522461,0.7551614046096802,0.3431469202041626,0.5049160122871399,-0.4043446481227875,-0.4650599956512451},{0.15692123770713806,0.2767969071865082,0.3293270468711853,-0.3646138608455658,-0.2640354633331299,-0.44092419743537903,-0.15506252646446228,-0.39232906699180603},{0.31990769505500793,0.5702754855155945,-0.27274268865585327,0.6209384202957153,0.22681574523448944,0.5122143626213074,0.24482029676437378,0.050971101969480515},{-0.22394955158233643,-0.7446122765541077,-0.5572765469551086,0.2927525043487549,0.2508552074432373,-0.3430320620536804,0.01953967660665512,-0.10196293145418167},{-0.23379656672477722,-0.6271827220916748,-0.36671432852745056,-0.49165141582489014,-0.3710065484046936,-0.5316808819770813,0.243482768535614,0.48218733072280884}};
static const float actor_encoder_self_encoder_0_weight[18][16]                  = {{-0.031018933281302452,-0.04903430491685867,0.15254446864128113,-0.17913265526294708,-0.2090536504983902,0.1397654265165329,0.08791153132915497,-0.02507159113883972,0.02542395144701004,0.13249771296977997,-0.27527710795402527,-0.021920954808592796,-0.50102299451828,-0.2713545858860016,-0.24709907174110413,-0.2133326232433319},{-0.03944525495171547,0.16252681612968445,0.25536733865737915,-0.12730365991592407,-0.10948043316602707,-0.07375466078519821,-0.17340639233589172,-0.02538568153977394,0.06766553968191147,-0.0891268327832222,0.234083890914917,0.21642336249351501,0.3791351318359375,-0.3258776366710663,0.22442001104354858,0.00990526657551527},{0.3922114968299866,0.12814433872699738,0.2134581208229065,-0.5444064140319824,-0.35901790857315063,-0.03841125965118408,-0.01203202735632658,0.13333822786808014,-0.32681530714035034,-0.508092999458313,0.345683217048645,-0.14994221925735474,-0.05070125311613083,0.13618351519107819,-0.42810532450675964,-0.35333868861198425},{0.056069254875183105,-0.22816234827041626,0.24036358296871185,-0.15716475248336792,0.08038957417011261,0.012697269208729267,0.4084399342536926,-0.3508729934692383,0.003424266818910837,-0.036326270550489426,0.10144544392824173,-0.17787659168243408,-0.2825414538383484,-0.09991493076086044,0.2673330307006836,-0.17535635828971863},{0.03861524909734726,0.10562614351511002,-0.11921524256467819,-0.19730789959430695,-0.3321033716201782,0.09528689086437225,-0.2931520342826843,-0.029306726530194283,0.1583172082901001,-0.13977831602096558,0.009136865846812725,0.22037191689014435,0.20775820314884186,-0.1293354332447052,-0.0027840123511850834,-0.41208943724632263},{0.33524200320243835,-0.26048025488853455,-0.09759555011987686,-0.032430510967969894,-0.04446733370423317,-0.1300787627696991,0.05449928343296051,-0.3470839560031891,-0.23064318299293518,-0.29110226035118103,0.1783038228750229,-0.32536637783050537,-0.1799236536026001,0.22393248975276947,0.16437728703022003,-0.27050480246543884},{0.11711446940898895,-0.1258123368024826,0.16250896453857422,-0.18029563128948212,0.3239893317222595,0.12332002073526382,0.256883829832077,-0.30046331882476807,-0.3181847631931305,0.03628160059452057,0.0722464844584465,0.3217572867870331,0.002917048754170537,0.09881971031427383,-0.30693548917770386,0.25277644395828247},{0.02697838470339775,0.2504666745662689,0.39444875717163086,-0.21513211727142334,-0.4401679039001465,0.031072843819856644,0.3542817234992981,0.5514721870422363,-0.09998580068349838,0.10344146192073822,-0.17872074246406555,0.21242599189281464,0.019770853221416473,0.34160709381103516,0.13164523243904114,-0.23803898692131042},{0.2394406646490097,-0.15171650052070618,0.29815375804901123,-0.4332188069820404,-0.0012124853674322367,0.5013760328292847,-0.17313611507415771,0.3228587210178375,-0.09212997555732727,0.09453337639570236,0.07867120206356049,0.24171297252178192,-0.32538920640945435,-0.42803066968917847,-0.06397418677806854,0.0159323550760746},{0.2968144416809082,0.3437310457229614,-0.16263751685619354,0.051475267857313156,0.4368680715560913,0.4318280816078186,-0.167356476187706,0.20004792511463165,-0.512752115726471,-0.2352786809206009,-0.02886922098696232,-0.059609897434711456,-0.04780206084251404,-0.0701831579208374,-0.29234814643859863,0.1359100639820099},{-0.17139914631843567,-0.09296843409538269,-0.08397351205348969,-0.1175970807671547,0.051025159657001495,-0.06336159259080887,-0.2174803912639618,0.27598100900650024,-0.16536591947078705,0.4251788258552551,0.045256610959768295,-0.4424797296524048,0.3530897796154022,-0.16620957851409912,-0.013847378082573414,-0.33231186866760254},{0.18395113945007324,0.36291930079460144,-0.005687751341611147,-0.08617047220468521,-0.06327944248914719,-0.46663686633110046,-0.265582412481308,-0.14549235999584198,-0.4600701630115509,-0.5091957449913025,-0.2957649230957031,0.49282634258270264,0.40294361114501953,0.07093401253223419,0.42463579773902893,-0.20922042429447174},{-0.2059803605079651,0.3471727967262268,-0.16837596893310547,0.2542533576488495,0.25999897718429565,-0.0844656378030777,-0.45792055130004883,-0.3957977592945099,-0.3887403905391693,-0.27680596709251404,0.32771727442741394,0.3081904947757721,0.28374847769737244,-0.22696730494499207,0.14184372127056122,-0.3293233811855316},{-0.30533987283706665,0.08182192593812943,0.04253539443016052,0.5268346667289734,0.5582253336906433,-0.47837522625923157,-0.052291139960289,-0.07123744487762451,-0.28536421060562134,-0.17407917976379395,-0.1866806000471115,-0.2882325351238251,-0.08508660644292831,0.5992736220359802,-0.01917940191924572,-0.185867041349411},{-0.09102647006511688,-0.007819305174052715,0.2031240165233612,0.15793175995349884,-0.04472079873085022,-0.1456081122159958,-0.16399610042572021,0.3234143853187561,-0.015227220021188259,0.004656542558223009,-0.14309394359588623,0.11619250476360321,-0.15662279725074768,-0.08433963358402252,0.0515391007065773,0.1229427233338356},{0.25190526247024536,0.21381859481334686,0.1122342124581337,0.31126174330711365,0.2533721923828125,-0.23220396041870117,-0.13910165429115295,0.2518374025821686,0.12007841467857361,-0.22699442505836487,-0.5210142731666565,-0.2716669738292694,-0.4021501839160919,0.13896948099136353,0.38785022497177124,0.4194444417953491},{0.1925029456615448,-0.39574089646339417,0.10620646178722382,0.018625933676958084,0.01757287234067917,0.17314857244491577,0.2788996696472168,-0.035961247980594635,-0.06657253205776215,-0.2632625699043274,-0.13805240392684937,-0.05296865105628967,-0.19174353778362274,0.22087235748767853,0.04860702529549599,0.22568705677986145},{0.24109598994255066,0.31148117780685425,-0.3288581073284149,0.15982182323932648,0.42955267429351807,0.303905189037323,-0.1399422585964203,-0.20917631685733795,-0.11545847356319427,0.2571240961551666,0.03249222785234451,0.10040269792079926,-0.035825204104185104,-0.07280854135751724,0.1706901490688324,0.6073858141899109}};
static const float actor_encoder_self_encoder_2_weight[16][16]                  = {{-0.17250661551952362,0.0889984741806984,-0.24515597522258759,-0.19764800369739532,0.2909010946750641,-0.19199366867542267,-0.10222907364368439,0.41541433334350586,0.12563671171665192,-0.40470975637435913,-0.12067455053329468,-0.2949649393558502,0.45388394594192505,-0.0015194342704489827,0.30957117676734924,0.2061644047498703},{-0.40640512108802795,0.35793381929397583,-0.24684923887252808,-0.1172795444726944,-0.41060420870780945,-0.21257536113262177,0.02050808258354664,0.29498976469039917,0.29302746057510376,0.017761114984750748,-0.23668894171714783,0.18330058455467224,-0.2787834703922272,0.13991650938987732,0.10345380008220673,-0.18596354126930237},{0.0888807475566864,-0.30275553464889526,0.1735355406999588,0.27632400393486023,-0.11041759699583054,0.46552643179893494,0.0070717716589570045,-0.13338987529277802,0.10531497001647949,-0.07214398682117462,0.2403702288866043,-0.20237760245800018,-0.01301000826060772,-0.3930271863937378,-0.18435509502887726,0.19870996475219727},{0.1024332195520401,0.4014759063720703,0.052408263087272644,-0.1879507452249527,-0.23142942786216736,-0.13611003756523132,-0.35622185468673706,-0.2634810209274292,0.20033450424671173,0.30908912420272827,-0.027617255225777626,-0.21813839673995972,-0.29534661769866943,0.08819543570280075,0.158548966050148,0.19414089620113373},{0.0814201608300209,-0.25255391001701355,0.010223421268165112,-0.42988690733909607,-0.5807251334190369,-0.12318094074726105,-0.5235942602157593,0.03855597972869873,-0.02092882990837097,0.1804092973470688,0.03424849361181259,0.09791869670152664,-0.02030067704617977,-0.21939344704151154,-0.039427418261766434,-0.32754161953926086},{-0.33803531527519226,-0.34806182980537415,0.39754578471183777,-0.13857319951057434,-0.3479989767074585,0.06504280865192413,-0.1920766979455948,0.2704809010028839,-0.3762766122817993,-0.09869308024644852,0.26790493726730347,-0.34844082593917847,0.4127301275730133,-0.028452180325984955,-0.11550237983465195,-0.3622928857803345},{-0.18043045699596405,0.12071052938699722,-0.348723828792572,-0.23548050224781036,0.32379165291786194,-0.12675881385803223,0.0647234246134758,-0.3075388967990875,-0.29624032974243164,-0.02479284442961216,0.39523473381996155,-0.06745459139347076,0.24996452033519745,0.427751749753952,-0.23439264297485352,-0.11337732523679733},{0.15513093769550323,0.18262724578380585,-0.09435965120792389,-0.15206101536750793,0.03886943310499191,0.27752068638801575,0.0439235158264637,0.060054436326026917,-0.23063316941261292,-0.07910410314798355,0.30557745695114136,-0.33123284578323364,0.06854013353586197,-0.23930047452449799,-0.00019569748837966472,0.38006070256233215},{0.22487369179725647,-0.09054054319858551,0.20287296175956726,-0.043103788048028946,0.24283254146575928,0.21410825848579407,-0.1424015760421753,-0.21900248527526855,-0.07948135584592819,0.38774004578590393,0.2950858175754547,0.04460710659623146,-0.16905875504016876,-0.004669711925089359,-0.30529600381851196,0.3380647599697113},{-0.15777696669101715,0.2665688693523407,0.28937703371047974,-0.3152084946632385,-0.3377033770084381,-0.19028475880622864,-0.03787771612405777,0.27432575821876526,0.19502855837345123,-0.02033669501543045,0.30304232239723206,-0.028121573850512505,0.001100241905078292,-0.28021931648254395,-0.22405558824539185,-0.03661588206887245},{-0.15390601754188538,0.17228122055530548,-0.02498406358063221,0.0006829328485764563,0.0001096387641155161,0.04022059962153435,-0.014795215800404549,0.359122097492218,-0.04798692464828491,-0.3054373562335968,-0.3174360692501068,-0.08917464315891266,-0.10444783419370651,-0.0022412159014493227,-0.06270250678062439,-0.250919371843338},{-0.02296174131333828,-0.130048006772995,0.3571440577507019,0.15426407754421234,0.19902624189853668,0.18165729939937592,-0.0596613809466362,-0.26043063402175903,-0.3600124716758728,-0.46049946546554565,-0.0010644645662978292,-0.10696038603782654,-0.2517651319503784,0.24917830526828766,0.1828596293926239,-0.304826557636261},{-0.11721901595592499,0.3995817005634308,-0.3433155417442322,0.305083304643631,0.37115639448165894,-0.3768242299556732,0.04011200740933418,-0.1125350147485733,0.0204269178211689,0.08747289329767227,-0.20950114727020264,-0.14046664535999298,0.0489540696144104,0.278864324092865,0.37557658553123474,-0.3038928508758545},{-0.25557997822761536,0.2609767019748688,-0.2995114028453827,-0.24900829792022705,-0.22332797944545746,0.029881911352276802,0.23508913815021515,0.3324137032032013,-0.16076722741127014,-0.20213507115840912,0.11362850666046143,0.24780720472335815,-0.3030807673931122,-0.15258252620697021,-0.28515228629112244,-0.1999421864748001},{0.34838876128196716,0.4181590676307678,0.011147022247314453,0.25158408284187317,0.040047332644462585,-0.1994689255952835,0.3118886649608612,-0.23504847288131714,-0.13778957724571228,-0.1889900416135788,-0.2885737717151642,-0.08995108306407928,0.2276245802640915,0.469139039516449,0.13142390549182892,0.039011139422655106},{-0.07356281578540802,-0.23650743067264557,-0.2990363538265228,0.1445603221654892,-0.3646031320095062,-0.390095591545105,0.16991962492465973,-0.17337985336780548,0.07972879707813263,0.32810887694358826,-0.001167416456155479,0.45443686842918396,-0.3221272826194763,-0.040742237120866776,-0.30759114027023315,-0.11725423485040665}};
static const float actor_encoder_feed_forward_0_weight[24][32]                  = {{0.165548637509346,0.2863088846206665,0.25215497612953186,0.12970474362373352,-0.008611702360212803,0.3127811849117279,0.3362376391887665,0.02276952750980854,0.03173055499792099,-0.2194308340549469,0.31947627663612366,0.20037449896335602,0.2654592990875244,-0.13967829942703247,0.15952168405056,-0.1808711141347885,-0.24828848242759705,0.043776705861091614,-0.03911830857396126,-0.06535740196704865,0.12547625601291656,-0.23809941112995148,-0.31449705362319946,-0.0500149205327034,0.030889352783560753,0.12548162043094635,-0.12845245003700256,0.1591419279575348,0.13616429269313812,-0.21391630172729492,-0.08126413077116013,-0.09454455971717834},{0.10724244266748428,-0.36988675594329834,0.31596237421035767,0.05644363909959793,-0.21064728498458862,0.09332821518182755,-0.1861274540424347,0.08249673992395401,0.13890492916107178,0.1827639937400818,0.1324959248304367,-0.06755716353654861,0.1718844175338745,0.035731468349695206,0.3248232305049896,0.07967253029346466,-0.2919883728027344,-0.23905497789382935,0.20125198364257812,-0.3231845498085022,-0.29991504549980164,-0.1495707482099533,-0.010350492782890797,0.26666611433029175,0.06596096605062485,0.08277302980422974,0.24573102593421936,0.20131726562976837,-0.08756325393915176,-0.07334188371896744,0.09724805504083633,0.03765656799077988},{0.27436503767967224,-0.031712763011455536,-0.02549358457326889,0.11505627632141113,0.0865129679441452,0.24583351612091064,0.06279155611991882,0.3309038281440735,0.15425051748752594,-0.16288535296916962,-0.2692001461982727,0.2031647264957428,-0.13454708456993103,0.13544270396232605,-0.09974756836891174,-0.03478757292032242,-0.21628043055534363,-0.07981083542108536,-0.20498496294021606,-0.20400811731815338,0.3430643677711487,0.04806828498840332,0.02611469104886055,-0.3057570457458496,-0.2009945809841156,0.1275230050086975,0.3314143717288971,-0.12756310403347015,-0.1600898653268814,-0.16161461174488068,-0.24524830281734467,-0.28623801469802856},{0.22792023420333862,0.09849434345960617,-0.16491901874542236,0.041439238935709,-0.09856481105089188,-0.3204212188720703,0.10968124121427536,0.14832302927970886,0.2456941306591034,-0.13705943524837494,0.13303597271442413,0.05818861350417137,-0.15914416313171387,-0.308947890996933,0.15198442339897156,-0.23179073631763458,-0.15308114886283875,0.00026592938229441643,0.17576047778129578,0.22774146497249603,0.03277329355478287,0.07782016694545746,0.15015819668769836,0.06069754809141159,0.0688459649682045,0.17961066961288452,0.12088212370872498,0.11258804798126221,0.014808318577706814,0.17815731465816498,0.17827467620372772,0.09133456647396088},{-0.18519777059555054,-0.17564691603183746,0.2757846713066101,0.176356241106987,-0.18318016827106476,-0.2491452693939209,0.33072927594184875,-0.24760065972805023,-0.21251113712787628,0.154563307762146,-0.07734250277280807,-0.21711365878582,0.16731035709381104,0.09444442391395569,0.35504263639450073,-0.06921830773353577,0.2214304506778717,0.2581084370613098,-0.2506134510040283,0.29292625188827515,0.23286135494709015,0.3239833116531372,0.1375671774148941,0.0017259785672649741,0.09393451362848282,-0.1713894009590149,0.13952156901359558,0.16546617448329926,-0.084422767162323,0.21307718753814697,-0.09201539307832718,-0.03154789283871651},{0.0823935866355896,0.07131874561309814,0.09303906559944153,-0.2637554109096527,0.19461362063884735,-0.18300369381904602,0.1795007586479187,0.2143208235502243,0.0040171449072659016,-0.05647912621498108,0.22000724077224731,0.2711363434791565,-0.2980113625526428,-0.41725847125053406,-0.25611427426338196,-0.16077129542827606,-0.19125449657440186,0.2890952527523041,-0.1443784534931183,-0.022767379879951477,-0.09139111638069153,0.02156052179634571,0.25931262969970703,-0.19771763682365417,-0.12104329466819763,0.12639622390270233,-0.15556883811950684,-0.1232658177614212,0.1050044521689415,-0.19642023742198944,-0.04650557041168213,-0.22416220605373383},{-0.10965277999639511,-0.29638734459877014,-0.1336819976568222,0.03711295872926712,-0.14338186383247375,0.053498275578022,0.08067284524440765,-0.39322036504745483,0.17291009426116943,0.13896812498569489,-0.24080245196819305,0.015470600686967373,-0.2528306245803833,-0.007644972298294306,-0.10945814102888107,-0.1533440500497818,-0.04444938898086548,0.04363715648651123,-0.25738197565078735,-0.00965855922549963,0.012498913332819939,0.03381204232573509,0.11729078739881516,-0.08625461161136627,0.17951764166355133,0.245568186044693,-0.026811307296156883,0.10035119950771332,0.18334798514842987,0.156536266207695,-0.11607272177934647,-0.07332448661327362},{-0.11725279688835144,-0.286172479391098,-0.1668238639831543,0.13050031661987305,-0.26799362897872925,-0.19263318181037903,-0.20886389911174774,0.13047218322753906,-0.27210965752601624,0.08933649957180023,-0.36854952573776245,0.14060112833976746,-0.030159419402480125,0.09960952401161194,-0.12262926995754242,-0.1727864146232605,0.09377150982618332,0.06880615651607513,-0.2936023771762848,0.029818834736943245,0.2441614270210266,0.2858980596065521,-0.06211226060986519,0.22608768939971924,-0.15902680158615112,-0.22461548447608948,0.004316249396651983,0.03565507009625435,-0.0530521459877491,-0.16918298602104187,-0.1827777624130249,0.2208535522222519},{-0.12896020710468292,-0.008873126469552517,0.24044182896614075,0.329866498708725,0.0093692597001791,0.23599034547805786,-0.2139102965593338,-0.0066005573607981205,0.159515842795372,0.19857275485992432,-0.2926354706287384,-0.23563821613788605,-0.16484299302101135,-0.24533888697624207,-0.2570897936820984,0.22992412745952606,0.27538126707077026,0.12150809168815613,0.005843081511557102,-0.3449860215187073,0.19480308890342712,0.14923633635044098,0.18441163003444672,-0.11301806569099426,0.2031986117362976,-0.002508623991161585,0.17489606142044067,0.20576941967010498,-0.27203819155693054,0.11148462444543839,0.12748217582702637,0.13444072008132935},{-0.16381113231182098,0.08636856079101562,-0.09233440458774567,-0.16748683154582977,0.3252894878387451,0.14175501465797424,-0.23956142365932465,-0.23794423043727875,0.005350511986762285,0.13866020739078522,0.2751087546348572,0.049992356449365616,0.3267776370048523,-0.172355055809021,0.08228051662445068,0.03972657397389412,0.281791627407074,-0.17538729310035706,0.35882970690727234,-0.07569841295480728,-0.11999750882387161,-0.22076457738876343,-0.0741015300154686,-0.23171047866344452,-0.03998527303338051,0.3354595899581909,0.088467538356781,-0.11364720016717911,0.09320942312479019,-0.11709617078304291,0.028492745012044907,0.027418794110417366},{-0.3113839626312256,0.035113248974084854,-0.20888164639472961,-0.017513202503323555,0.015149656683206558,-0.232638880610466,0.17157532274723053,0.07198678702116013,0.15597319602966309,0.1285368651151657,0.30877092480659485,-0.17370952665805817,-0.1012643352150917,0.045435525476932526,-0.2536003887653351,0.29559969902038574,-0.23107211291790009,0.24954786896705627,0.09535152465105057,-0.06491445749998093,-0.17130796611309052,-0.3232060372829437,0.25904718041419983,-0.1683199554681778,-0.05297330766916275,0.13881313800811768,-0.13569782674312592,0.06286526471376419,0.2682991623878479,-0.018691154196858406,-0.10870005935430527,-0.16262207925319672},{0.1874050348997116,0.15401604771614075,0.046143606305122375,-0.22684596478939056,-0.2622026205062866,-0.08599621802568436,0.009133309125900269,-0.23319940268993378,0.04436742514371872,0.23195414245128632,-0.2663395404815674,0.13576093316078186,0.2038508802652359,0.054147738963365555,-0.030442601069808006,-0.2170075625181198,-0.027500025928020477,-0.08648991584777832,0.08367019146680832,-0.21757885813713074,-0.03430845960974693,0.014513397589325905,-0.09031491726636887,-0.007272348739206791,0.13192543387413025,0.11008887737989426,0.13439561426639557,-0.028848757967352867,0.11911813169717789,-0.24170894920825958,0.05113131180405617,-0.11078318953514099},{0.01040643360465765,0.0834556519985199,-0.3466234505176544,-0.24925559759140015,0.30890801548957825,-0.0619460754096508,0.27517640590667725,0.23284220695495605,-0.06175446882843971,-0.3038301467895508,-0.23459933698177338,-0.04799797758460045,0.09751888364553452,-0.005497129634022713,-0.30149388313293457,0.2707671523094177,-0.10772768408060074,0.0780109167098999,0.23576250672340393,0.23100461065769196,0.31667208671569824,0.08490587770938873,-0.04070252925157547,0.20310159027576447,0.2578403353691101,-0.18349520862102509,-0.033983856439590454,-0.3385297656059265,-0.28302058577537537,-0.1637103110551834,-0.20023596286773682,-0.2867584228515625},{0.11127010732889175,0.1594184935092926,-0.1995050013065338,0.12938497960567474,0.19505029916763306,-0.1499605029821396,-0.17156079411506653,-0.17076338827610016,0.024450218304991722,-0.33732059597969055,0.05705626308917999,-0.18800385296344757,-0.010643498972058296,0.07786644250154495,-0.009816890582442284,0.021439742296934128,0.14095064997673035,0.11550642549991608,-0.06664092093706131,-0.26522693037986755,0.07462213933467865,-0.09229639917612076,0.0097115533426404,-0.3451831340789795,-0.20731838047504425,0.21786530315876007,0.3366422951221466,0.14566241204738617,0.033996231853961945,-0.1014770045876503,0.2651338577270508,-0.11861586570739746},{0.03289090096950531,-0.33300450444221497,-0.006742897909134626,-0.2401239275932312,0.026354771107435226,0.10656540095806122,-0.13285860419273376,0.10333292186260223,0.19626285135746002,-0.00897903461009264,0.3006244897842407,-0.10394925624132156,0.09940297156572342,-0.07917380332946777,0.16626550257205963,0.1808050274848938,0.3006635010242462,0.21040140092372894,-0.2205318957567215,-0.15963660180568695,-0.12227382510900497,-0.06963489204645157,-0.01714373007416725,0.2722946107387543,0.15577369928359985,0.060592491179704666,0.15703119337558746,-0.08864322304725647,-0.035611771047115326,0.057188730686903,0.26321426033973694,0.03319592773914337},{-0.16451941430568695,0.2363359034061432,-0.040906209498643875,0.19931820034980774,0.2559571862220764,-0.07403424382209778,0.09996965527534485,-0.166115865111351,-0.16841603815555573,-0.23478102684020996,-0.23961296677589417,-0.16764913499355316,-0.15912282466888428,-0.18113450706005096,-0.34105053544044495,0.20675739645957947,0.14159511029720306,-0.2710351347923279,0.15022560954093933,-0.19345740973949432,-0.35944560170173645,-0.1633337140083313,-0.14771142601966858,0.0335647389292717,0.16719548404216766,0.2135811299085617,0.3494219183921814,0.1898880898952484,0.08042045682668686,0.11813060939311981,-0.12203775346279144,-0.04885008931159973},{0.05108208954334259,0.24015122652053833,0.01623171754181385,-0.06791720539331436,0.05025094375014305,0.05409659445285797,0.20795758068561554,-0.16106016933918,-0.04420057684183121,0.06671446561813354,0.01671139895915985,0.12671683728694916,-0.3547048568725586,0.03500550240278244,-0.160459503531456,0.03125905618071556,0.17769359052181244,-0.09621760249137878,-0.06746950000524521,-0.03611309826374054,-0.39141646027565,0.18918481469154358,-0.17234016954898834,0.22564226388931274,0.09332600980997086,-0.1931188851594925,-0.005840154830366373,-0.12597179412841797,-0.08645574003458023,0.2654884457588196,0.20262573659420013,0.013344173319637775},{-0.15591377019882202,-0.128669872879982,-0.14534057676792145,0.3299470543861389,-0.4347221553325653,-0.3337540030479431,-0.11046314239501953,-0.11232433468103409,0.20619674026966095,-0.024736450985074043,-0.3035750985145569,0.007601420395076275,0.19695492088794708,0.1767333745956421,-0.200413778424263,0.1477925330400467,-0.16282257437705994,-0.1868227869272232,-0.05075287073850632,-0.11003486812114716,-0.05250418931245804,-0.005278231110423803,-0.025008762255311012,0.13344211876392365,0.10998823493719101,-0.31699517369270325,0.015205707401037216,0.23226039111614227,0.06722836941480637,0.13346225023269653,-0.009568422101438046,-0.18206016719341278},{-0.018369710072875023,0.03307707980275154,0.3265568017959595,-0.013196245767176151,-0.03829047083854675,-0.1954893171787262,-0.14823678135871887,0.24619384109973907,0.29129156470298767,0.1433715522289276,0.053809475153684616,-0.20577949285507202,-0.11733820289373398,0.2059842050075531,0.1779368817806244,-0.006099057849496603,0.060088980942964554,0.322083979845047,0.2729654908180237,0.12952262163162231,-0.16625364124774933,-0.12427526712417603,0.03680907562375069,-0.0021447534672915936,-0.05699565261602402,0.41147923469543457,0.24759812653064728,0.02048170194029808,0.19809693098068237,-0.1382169872522354,-0.1194630041718483,0.30120643973350525},{-0.2508203387260437,-0.0040075574070215225,0.14787627756595612,0.23887626826763153,0.2819255292415619,-0.12083324044942856,0.03220931440591812,-0.1415688693523407,0.11456670612096786,-0.1489858478307724,-0.029080918058753014,-0.08918736129999161,-0.08647201955318451,-0.0598665326833725,-0.11096388101577759,0.33895447850227356,-0.09137587249279022,-0.30187809467315674,-0.01913377083837986,-0.22660183906555176,0.0641394779086113,-0.2130356729030609,0.08035159111022949,-0.04396592453122139,-0.25478485226631165,0.36272433400154114,-0.27635622024536133,-0.32356950640678406,-0.275719553232193,0.271860271692276,0.21952290832996368,-0.11324106156826019},{0.19763913750648499,-0.044437624514102936,0.23569418489933014,0.11076456308364868,0.23312298953533173,-0.12902583181858063,-0.04482070729136467,-0.1991724818944931,-0.2047891616821289,0.15898965299129486,-0.25481483340263367,-0.20602335035800934,0.24491390585899353,0.24307216703891754,-0.15319444239139557,0.10999148339033127,-0.041535742580890656,0.18074436485767365,0.028506888076663017,0.0028836631681770086,-0.23803813755512238,0.08621937781572342,0.18509534001350403,-0.2628064751625061,0.06637653708457947,0.1549668163061142,0.05563608556985855,0.23010507225990295,-0.1707807332277298,-0.001014758599922061,-0.10636614263057709,-0.3405689001083374},{-0.22256752848625183,-0.16131265461444855,0.15767745673656464,0.06319500505924225,0.31293684244155884,0.321688711643219,0.004779264330863953,0.20264387130737305,-0.005469420459121466,0.20849038660526276,0.2556661069393158,-0.0988365188241005,-0.04690715670585632,0.2076721340417862,0.2167155146598816,-0.24180470407009125,-0.14936423301696777,0.3242211937904358,0.06310476362705231,0.07124941051006317,0.2059716135263443,-0.1572391837835312,-0.1387719213962555,-0.288663774728775,-0.21469390392303467,-0.12167241424322128,-0.15897098183631897,-0.05558052286505699,0.24297082424163818,-0.21661150455474854,0.17400451004505157,-0.24424317479133606},{0.08964931219816208,-0.3432861566543579,-0.15643619000911713,0.1268729716539383,-0.26045921444892883,-0.12774024903774261,-0.16180415451526642,0.06743454188108444,0.21741072833538055,0.2696287930011749,0.08737099915742874,-0.23755435645580292,0.1766425222158432,0.2841125428676605,-0.06271103024482727,0.15894083678722382,-0.11907529830932617,0.17651639878749847,-0.25185924768447876,0.29328206181526184,0.17644304037094116,-0.007613664958626032,0.2506958246231079,0.15697301924228668,-0.2234710156917572,-0.12652888894081116,0.23774513602256775,0.10041920840740204,-0.2136567234992981,-0.24136000871658325,-0.1489487737417221,-0.2742682695388794},{-0.21799984574317932,-0.06833849102258682,-0.10232584923505783,-0.02437206730246544,-0.11290857940912247,-0.13509680330753326,-0.1609487235546112,0.006706795655190945,-0.174944207072258,-0.057572972029447556,-0.23434339463710785,-0.34318867325782776,0.09329453110694885,-0.22771386802196503,-0.15267828106880188,0.11536100506782532,0.18455344438552856,0.2956324815750122,-0.2884601056575775,-0.05938486009836197,-0.07776924967765808,0.08762295544147491,0.29202598333358765,0.047139037400484085,0.06637320667505264,-0.2635205090045929,0.2032393366098404,-0.2275843322277069,-0.0759054496884346,0.01802334003150463,-0.2235298901796341,-0.040121618658304214}};
static const float action_parameterization_distribution_linear_weight[32][4]    = {{0.0018238559132441878,-0.01863468810915947,-0.020803678780794144,-0.026661641895771027},{0.2304447740316391,-0.003921112045645714,0.24846939742565155,0.23613014817237854},{-0.19012326002120972,0.10261399298906326,-0.0011009230511263013,0.04405145347118378},{0.2036546766757965,0.01578429341316223,-0.05993053317070007,-0.048721276223659515},{0.0937611311674118,0.040163833647966385,0.12224852293729782,-0.08174875378608704},{0.29192858934402466,0.17036843299865723,0.1942616105079651,0.13665315508842468},{-0.2827511727809906,-0.09268619865179062,-0.14438261091709137,-0.3329290449619293},{0.003854658454656601,-0.2581993341445923,0.14426621794700623,-0.34784233570098877},{-0.24502643942832947,0.18561801314353943,0.28998690843582153,0.280564546585083},{0.167038694024086,0.10391206294298172,-0.20045974850654602,-0.21710984408855438},{0.20467443764209747,0.28798913955688477,-0.1788179874420166,0.17192621529102325},{-0.015466689132153988,0.2556988000869751,0.18293997645378113,-0.29969799518585205},{0.10072669386863708,0.210373193025589,0.04475509375333786,-0.3559015691280365},{0.19216634333133698,-0.02324710041284561,0.2389482706785202,-0.14128609001636505},{-0.32563474774360657,-0.1258542835712433,0.04180607944726944,0.20543111860752106},{0.11665858328342438,-0.103118397295475,-0.04057904705405235,0.10901924222707748},{-0.35756999254226685,-0.3036474585533142,0.2791370749473572,-0.335074245929718},{-0.020006848499178886,0.02300744503736496,0.021364882588386536,-0.03290761262178421},{0.19527409970760345,0.005405698902904987,0.062245819717645645,0.12917029857635498},{-0.050760846585035324,-0.1879386007785797,-0.07814856618642807,-0.1432333141565323},{-0.00594307528808713,-0.1559974104166031,-0.1347922533750534,-0.046704795211553574},{0.05272557586431503,-0.15034478902816772,-0.24249476194381714,0.14947637915611267},{-0.24699966609477997,0.1492871642112732,0.020183563232421875,-0.05043866112828255},{0.0312159713357687,-0.038376495242118835,-0.035607099533081055,0.06463071703910828},{0.2648259401321411,-0.09162598848342896,-0.19003906846046448,-0.27472394704818726},{-0.005158130545169115,-0.004294442944228649,0.21303342282772064,0.19884023070335388},{0.20693710446357727,0.16277194023132324,0.13944527506828308,0.07538390159606934},{-0.1370844542980194,0.14822208881378174,-0.07148536294698715,-0.20331621170043945},{0.288482666015625,-0.18595167994499207,-0.11398273706436157,-0.09148010611534119},{-0.19049377739429474,0.12724553048610687,0.10406583547592163,-0.1625024378299713},{0.1467801183462143,-0.18909673392772675,-0.0037006584461778402,-0.2738551199436188},{0.01607166975736618,0.18357835710048676,0.08695054799318314,0.009601542726159096}};
static const float actor_encoder_neighbor_encoder_embedding_mlp_0_bias[8]       = {-0.0006142810452729464,-0.01616438291966915,0.016026800498366356,0.0046602534130215645,0.00025187782011926174,0.03468603640794754,0.018035709857940674,-0.007819494232535362};
static const float actor_encoder_neighbor_encoder_embedding_mlp_2_bias[8]       = {-0.03183240070939064,-0.030890202149748802,0.05673544108867645,-0.055397383868694305,-0.001579359988681972,0.025896364822983742,0.0014418907230719924,0.01388280838727951};
static const float actor_encoder_self_encoder_0_bias[16]                        = {0.022532669827342033,0.03233788534998894,-0.11665879935026169,0.046988703310489655,-0.12139256298542023,-0.03376997262239456,-0.02049664407968521,-0.040222786366939545,-0.03284257650375366,-0.13422290980815887,0.0617852583527565,0.015856033191084862,-0.05088035762310028,-0.01473409403115511,0.043574973940849304,-0.050338953733444214};
static const float actor_encoder_self_encoder_2_bias[16]                        = {-0.03972839564085007,-0.010516771115362644,-0.027183569967746735,0.0034269350580871105,0.01453594584017992,-0.004183739423751831,-0.03482261672616005,0.03780607879161835,-0.053133148699998856,0.00911560095846653,-0.10481216013431549,0.06142324581742287,-0.043996818363666534,0.004994465969502926,0.045559898018836975,0.012189256027340889};
static const float actor_encoder_feed_forward_0_bias[32]                        = {-0.013435188680887222,0.05415460094809532,-0.030157512053847313,-0.026860270649194717,0.009520728141069412,-0.014130333438515663,-0.03752212971448898,0.046036671847105026,0.024855196475982666,0.01238095760345459,-0.015266450121998787,0.014718047343194485,0.03026280738413334,0.018908832222223282,0.0460311621427536,-0.013249906711280346,-0.00245852442458272,0.017190726473927498,0.007895594462752342,0.009437396191060543,0.003434461075812578,0.026211563497781754,-0.008385134860873222,0.015415524132549763,-0.02472931146621704,0.005269660148769617,0.004701168276369572,-0.03262000530958176,0.008149600587785244,-0.004086395259946585,-0.013967584818601608,0.011040610261261463};
static const float action_parameterization_distribution_linear_bias[4]          = {-0.00826839916408062,-0.022956326603889465,0.01663227565586567,0.0095604183152318};



void networkEvaluate(struct control_t_n *control_n, const float *state_array) {

  
      ///////////////////////////////// NEIGHBOR OUTPUT CALCULATION ///////////////////////////////////////////
      float meanNeighbArr[8];
      meanNeighbArr[0] = 0.0f;
      meanNeighbArr[1] = 0.0f;
      meanNeighbArr[2] = 0.0f;
      meanNeighbArr[3] = 0.0f;
      meanNeighbArr[4] = 0.0f;
      meanNeighbArr[5] = 0.0f;
      meanNeighbArr[6] = 0.0f;
      meanNeighbArr[7] = 0.0f;

        for(int k = 0; k < NEIGHBORS; k++)
        {
          for (int i = 0; i < structure[0][1]; i++) {
              output_0[i] = 0;
              for (int j = 0; j < structure[0][0]; j++) {
                output_0[i] += kNearestArr[k][j] * actor_encoder_neighbor_encoder_embedding_mlp_0_weight[j][i];
              }
              output_0[i] += actor_encoder_neighbor_encoder_embedding_mlp_0_bias[i];
              output_0[i] = tanhf(output_0[i]);
          }
      
          for (int i = 0; i < structure[1][1]; i++) {
              output_1[i] = 0;
              for (int j = 0; j < structure[1][0]; j++) {
                  output_1[i] += output_0[j] * actor_encoder_neighbor_encoder_embedding_mlp_2_weight[j][i];
              }
              output_1[i] += actor_encoder_neighbor_encoder_embedding_mlp_2_bias[i];
              output_1[i] = tanhf(output_1[i]);
          }


          meanNeighbArr[0] = meanNeighbArr[0]+output_1[0];
          meanNeighbArr[1] = meanNeighbArr[1]+output_1[1];
          meanNeighbArr[2] = meanNeighbArr[2]+output_1[2];
          meanNeighbArr[3] = meanNeighbArr[3]+output_1[3];
          meanNeighbArr[4] = meanNeighbArr[4]+output_1[4];
          meanNeighbArr[5] = meanNeighbArr[5]+output_1[5];
          meanNeighbArr[6] = meanNeighbArr[6]+output_1[6];
          meanNeighbArr[7] = meanNeighbArr[7]+output_1[7];


        } 

        meanNeighbArr[0] /= NEIGHBORS;
        meanNeighbArr[1] /= NEIGHBORS;
        meanNeighbArr[2] /= NEIGHBORS;
        meanNeighbArr[3] /= NEIGHBORS;
        meanNeighbArr[4] /= NEIGHBORS;
        meanNeighbArr[5] /= NEIGHBORS;
        meanNeighbArr[6] /= NEIGHBORS;
        meanNeighbArr[7] /= NEIGHBORS;

          /////////////////// SELF_OUTPUT ///////////////////////////////////////////////////////////////////
          for (int i = 0; i < structure[2][1]; i++) {
              output_2[i] = 0;
              for (int j = 0; j < structure[2][0]; j++) {
                  output_2[i] += state_array[j] * actor_encoder_self_encoder_0_weight[j][i];
              }
              output_2[i] += actor_encoder_self_encoder_0_bias[i];
              output_2[i] = tanhf(output_2[i]);

          }
          
          for (int i = 0; i < structure[3][1]; i++) {
              output_3[i] = 0;
              for (int j = 0; j < structure[3][0]; j++) {
                  output_3[i] += output_2[j] * actor_encoder_self_encoder_2_weight[j][i];
              }
              output_3[i] += actor_encoder_self_encoder_2_bias[i];
              output_3[i] = tanhf(output_3[i]);

          }
          

          ////////////////////////////////////////////////////// FEED FORWARD /////////////////////////////////////////////

          for(int k = 0; k < structure[3][1]; k++ )
          {
            inputff[k] = output_3[k];
          }

          for(int k = 0; k < structure[1][1]; k++ )
          {
            inputff[k+16] = meanNeighbArr[k];
          }

          for (int i = 0; i < structure[4][1]; i++) {
              output_4[i] = 0;
              for (int j = 0; j < structure[4][0]; j++) {
                  output_4[i] += inputff[j] * actor_encoder_feed_forward_0_weight[j][i];
              }
              output_4[i] += actor_encoder_feed_forward_0_bias[i];
              output_4[i] = tanhf(output_4[i]);
          }
          
          for (int i = 0; i < structure[5][1]; i++) {
              output_5[i] = 0;
              for (int j = 0; j < structure[5][0]; j++) {
                  output_5[i] += output_4[j] * action_parameterization_distribution_linear_weight[j][i];
              }
              output_5[i] += action_parameterization_distribution_linear_bias[i];
          }
        control_n->thrust_0 = output_5[0];
        control_n->thrust_1 = output_5[1];
        control_n->thrust_2 = output_5[2];
        control_n->thrust_3 = output_5[3];	
    }

int main_nn(float *outdatav)
{
    control_t_n motorThrusts;
    
    point_t pt;
    estimatorKalmanGetEstimatedPos(&pt);

    ///////////////////////////////////////////// update k nearest information
    float ownX = pt.x;
    float ownY = pt.y;
    float ownZ = pt.z;

    float farX = kNearestArr[farthestNeighb][0];
    float farY = kNearestArr[farthestNeighb][1];
    float farZ = kNearestArr[farthestNeighb][2];

    float lastX = dronesInfo[lastAdded][0];
    float lastY = dronesInfo[lastAdded][1];
    float lastZ = dronesInfo[lastAdded][2];

    float distFarX = (farX-ownX)*(farX-ownX);
    float distFarY = (farY-ownY)*(farY-ownY);
    float distFarZ = (farZ-ownZ)*(farZ-ownZ);

    float distLastX = (lastX-ownX)*(lastX-ownX);
    float distLastY = (lastY-ownY)*(lastY-ownY);
    float distLastZ = (lastZ-ownZ)*(lastZ-ownZ);

    float distFar  = sqrtf(distFarX  + distFarY  + distFarZ);
    float distLast = sqrtf(distLastX + distLastY + distLastZ);



    if(distLast < distFar) // if last added information is closer than farthest k nearest neighbor, update
    {

      // update infrmation
      kNearestArr[farthestNeighb][0] = dronesInfo[farthestNeighb][0];
      kNearestArr[farthestNeighb][1] = dronesInfo[farthestNeighb][1];
      kNearestArr[farthestNeighb][2] = dronesInfo[farthestNeighb][2];

      farthestNeighb = 0; // set new farthest neighbor to calcuate index of farthest neighbor

      // calculate distance to k nearest at index 0
      farX = kNearestArr[farthestNeighb][0];
      farY = kNearestArr[farthestNeighb][1];
      farZ = kNearestArr[farthestNeighb][2];

      distFarX = (farX-ownX)*(farX-ownX);
      distFarY = (farY-ownY)*(farY-ownY);
      distFarZ = (farZ-ownZ)*(farZ-ownZ);

      distFar  = sqrtf(distFarX  + distFarY  + distFarZ);

      for(int k = 1; k < NEIGHBORS; k++) // iteratio over all k nearest to compare distance
      {
        if(distFar < sqrtf((kNearestArr[k][0]-ownX)*(kNearestArr[k][0]-ownX)  + 
                           (kNearestArr[k][1]-ownY)*(kNearestArr[k][1]-ownY)  + 
                           (kNearestArr[k][2]-ownZ)*(kNearestArr[k][2]-ownZ))) // if k is nearest than farthest, change farthest
        {
          farthestNeighb = k;

          farX = kNearestArr[farthestNeighb][0];
          farY = kNearestArr[farthestNeighb][1];
          farZ = kNearestArr[farthestNeighb][2];

          distFarX = (farX-ownX)*(farX-ownX);
          distFarY = (farY-ownY)*(farY-ownY);
          distFarZ = (farZ-ownZ)*(farZ-ownZ);

          distFar  = sqrtf(distFarX  + distFarY  + distFarZ);

        }
        
      }

    }

  
  for(int k = 0; k < NGHBRS; k++)
  {
    kNearestArr[k][0] =  clip(kNearestArr[k][0], -10.0f, 10.0f);
    kNearestArr[k][1] =  clip(kNearestArr[k][1], -10.0f, 10.0f);
    kNearestArr[k][2] =  clip(kNearestArr[k][2], -10.0f, 10.0f);

    kNearestArr[k][3] =  clip(kNearestArr[k][3], -6.0f, 6.0f);
    kNearestArr[k][4] =  clip(kNearestArr[k][4], -6.0f, 6.0f);
    kNearestArr[k][5] =  clip(kNearestArr[k][5], -6.0f, 6.0f);


  }
  //////////////////////////////////////////////////////// get self information
  state_t ownState = getOwnState();

    // Orientation
	struct quat q = mkquat(ownState.attitudeQuaternion.x, 
						             ownState.attitudeQuaternion.y, 
						             ownState.attitudeQuaternion.z, 
						             ownState.attitudeQuaternion.w);

	rot = quat2rotmat(q);
  
	// angular velocity
  sensorData_t sensors = getSensorData();
	float omega_roll  = radians(sensors.gyro.x);
	float omega_pitch = radians(sensors.gyro.y);
	float omega_yaw   = radians(sensors.gyro.z);

	// the state vector
	state_array[0] = ownState.position.x - ownTarget[0];
	state_array[1] = ownState.position.y - ownTarget[1];
	state_array[2] = ownState.position.z - ownTarget[2];
	state_array[3] = ownState.velocity.x;
	state_array[4] = ownState.velocity.y;
	state_array[5] = ownState.velocity.z;
	state_array[6] = rot.m[0][0];
	state_array[7] = rot.m[0][1];
	state_array[8] = rot.m[0][2];
	state_array[9] = rot.m[1][0];
	state_array[10] = rot.m[1][1];
	state_array[11] = rot.m[1][2];
	state_array[12] = rot.m[2][0];
	state_array[13] = rot.m[2][1];
	state_array[14] = rot.m[2][2];
	state_array[15] = omega_roll;
	state_array[16] = omega_pitch;
	state_array[17] = omega_yaw;


state_array[0]  = clip(state_array[0] , -10.0f, 10.0f);
state_array[1]  = clip(state_array[1] , -10.0f, 10.0f);
state_array[2]  = clip(state_array[2] , -10.0f, 10.0f);
state_array[3]  = clip(state_array[3] , -3.0f, 3.0f);
state_array[4]  = clip(state_array[4] , -3.0f, 3.0f);
state_array[5]  = clip(state_array[5] , -3.0f, 3.0f);
state_array[6]  = clip(state_array[6] , -1.0f, 1.0f);
state_array[7]  = clip(state_array[7] , -1.0f, 1.0f);
state_array[8]  = clip(state_array[8] , -1.0f, 1.0f);
state_array[9]  = clip(state_array[9] , -1.0f, 1.0f);
state_array[10] = clip(state_array[10], -1.0f, 1.0f);
state_array[11] = clip(state_array[11], -1.0f, 1.0f);
state_array[12] = clip(state_array[12], -1.0f, 1.0f);
state_array[13] = clip(state_array[13], -1.0f, 1.0f);
state_array[14] = clip(state_array[14], -1.0f, 1.0f);
state_array[15] = clip(state_array[15], -40.0f, 40.0f);
state_array[16] = clip(state_array[16], -40.0f, 40.0f);
state_array[17] = clip(state_array[17], -40.0f, 40.0f);



  networkEvaluate(&motorThrusts, state_array);

  outdatav[0] = motorThrusts.thrust_0;
  outdatav[1] = motorThrusts.thrust_1;
  outdatav[2] = motorThrusts.thrust_2;
  outdatav[3] = motorThrusts.thrust_3;
    
  return 1;
}

float clip(float val, float min, float max)
{
  if(val < min)
      {
        return min;
      }
      else if(val > max)
      {
        return max;
      }
      else
      {
        return val;
      }
}



void communicate()
{
  if (timer == ownPacket.id)
  {
    ownPacket.pos = getPosition();
    ownPacket.vel = getVeloc();
    P2PPacket packet;
    packet.port = 0;
    packet.size = sizeof(PacketData);
    memcpy(packet.data, &ownPacket, sizeof(PacketData));
    radiolinkSendP2PPacketBroadcast(&packet);
  }
}

void p2pcallbackHandler(P2PPacket *p)
{
    PacketData received;
    memcpy(&received, p->data, sizeof(PacketData));
    lastAdded = received.id;
    
    dronesInfo[received.id][0] = received.pos.x;
    dronesInfo[received.id][1] = received.pos.x;
    dronesInfo[received.id][2] = received.pos.y;
    
    dronesInfo[received.id][3] = received.vel.x;
    dronesInfo[received.id][4] = received.vel.y;
    dronesInfo[received.id][5] = received.vel.z;

}


Vector3 getPosition(void)
{
    point_t pt;
    estimatorKalmanGetEstimatedPos(&pt);
    return (Vector3){.x = pt.x, .y=pt.y, .z=pt.z};
} 

Vector3 getVeloc(void)
{
    return getVelocity();
}

uint8_t isHighLevel()
{
  return highlvl;

}

void  getThrusts(uint16_t* trsts)
{
  trsts[0] = thrustsToMotor[0];
  trsts[1] = thrustsToMotor[1];
  trsts[2] = thrustsToMotor[2];
  trsts[3] = thrustsToMotor[3];
}

void appMain() { 
  	// control->enableDirectThrust = true; // in the code of quadswarms they use this, why? (seems they changed the firmware)
  vTaskDelay(M2T(10000));
  p2pRegisterCB(p2pcallbackHandler);

  uint64_t address = configblockGetRadioAddress();
  uint8_t my_id    = (uint8_t)((address) & 0x00000000ff);
  ownPacket.id     = my_id;
  point_t ownPosition;
  estimatorKalmanGetEstimatedPos(&ownPosition);

  Vector3 ownVeloc = getVeloc();

  for(int k = 0; k < NUMQUADS; k++)
  {
    dronesInfo[k][0] =  8.0f;
    dronesInfo[k][1] =  k*1.5f;
    dronesInfo[k][2] =  0.0f;

    dronesInfo[k][3] = 0.0f;
    dronesInfo[k][4] = 0.0f;
    dronesInfo[k][5] = 0.0f;

  }
  
  for(int k = 0; k < NGHBRS; k++)
  {
    kNearestArr[k][0]  = ownPosition.x - dronesInfo[k][0];
    kNearestArr[k][1]  = ownPosition.y - dronesInfo[k][1];
    kNearestArr[k][2]  = ownPosition.z - dronesInfo[k][2];

    kNearestArr[k][3]  = ownVeloc.x;
    kNearestArr[k][4]  = ownVeloc.y;
    kNearestArr[k][5]  = ownVeloc.z;
  }
    

  while(1) {

    vTaskDelay(M2T(1));
    estimatorKalmanGetEstimatedPos(&ownPosition);
    //communicate();
    timer++;
    if(timer >= NUMQUADS)
    {
      timer = 0;
    }

    switch (state)
    {
    case 0: // do nothing
      break;
    case 1: // start 
            
      for(int k = 0; k < 4; k++)
      {
        thrustsToMotor[k] = (uint16_t)(UINT16_MAX*thrusts[k]*(mototrKValue));
      }
      // motorsSetRatio(0, thrusts[1]);
      // motorsSetRatio(1, thrusts[2]);
      // motorsSetRatio(2, thrusts[3]);
      // motorsSetRatio(3, thrusts[0]);

      break;
    case 2: // land

      if(ownPosition.z < 0.15f)
      {
        for(int k = 0; k < 4; k++)
        {
            thrustsToMotor[k] = (uint16_t)(UINT16_MAX*(0.0f));
        }
        state = 0;
      }
      break;
    default:
      break;
    }
    main_nn(thrusts);
    
    for(int k = 0; k < 4; k++)
    {
      if(thrusts[k] < -1.0f)
      {
        thrusts[k] = -1.0f;
      }
      else if(thrusts[k] > 1.0f)
      {
        thrusts[k] = 1.0f;
      }

      thrusts[k] += 1.0f;
      thrusts[k] /= 2.0f;

      thrustsInt[k] = (uint16_t)(UINT16_MAX*thrusts[k]);

    }

  }
}



PARAM_GROUP_START(ctrlnn)
PARAM_ADD(PARAM_UINT8, stt,    &state)
PARAM_ADD(PARAM_UINT8, id,     &(ownPacket.id))
PARAM_ADD(PARAM_FLOAT, kVal, &mototrKValue)
PARAM_ADD(PARAM_FLOAT, targetx, &(ownTarget[0]))
PARAM_ADD(PARAM_FLOAT, targety, &(ownTarget[1]))
PARAM_ADD(PARAM_FLOAT, targetz, &(ownTarget[2]))
PARAM_GROUP_STOP(ctrlnn)




LOG_GROUP_START(logNN)         
LOG_ADD(LOG_INT16, id, &(ownPacket.id))

LOG_ADD(LOG_FLOAT, t0, &(thrusts[1]))
LOG_ADD(LOG_FLOAT, t1, &(thrusts[2]))
LOG_ADD(LOG_FLOAT, t2, &(thrusts[3]))
LOG_ADD(LOG_FLOAT, t3, &(thrusts[0]))

LOG_ADD(LOG_UINT16, tint0, &(thrustsInt[1]))
LOG_ADD(LOG_UINT16, tint1, &(thrustsInt[2]))
LOG_ADD(LOG_UINT16, tint2, &(thrustsInt[3]))
LOG_ADD(LOG_UINT16, tint3, &(thrustsInt[0]))

LOG_ADD(LOG_FLOAT, px, &(state_array[0]))
LOG_ADD(LOG_FLOAT, py, &(state_array[1]))
LOG_ADD(LOG_FLOAT, pz, &(state_array[2]))
LOG_ADD(LOG_FLOAT, vx, &(state_array[3]))
LOG_ADD(LOG_FLOAT, vy, &(state_array[4]))
LOG_ADD(LOG_FLOAT, vz, &(state_array[5]))

LOG_ADD(LOG_FLOAT, r0, &(state_array[6]))
LOG_ADD(LOG_FLOAT, r1, &(state_array[7]))
LOG_ADD(LOG_FLOAT, r2, &(state_array[8]))
LOG_ADD(LOG_FLOAT, r3, &(state_array[9]))
LOG_ADD(LOG_FLOAT, r4, &(state_array[10]))
LOG_ADD(LOG_FLOAT, r5, &(state_array[11]))
LOG_ADD(LOG_FLOAT, r6, &(state_array[12]))
LOG_ADD(LOG_FLOAT, r7, &(state_array[13]))
LOG_ADD(LOG_FLOAT, r8, &(state_array[14]))

LOG_ADD(LOG_FLOAT, wx, &(state_array[15]))
LOG_ADD(LOG_FLOAT, wy, &(state_array[16]))
LOG_ADD(LOG_FLOAT, wz, &(state_array[17]))

LOG_ADD(LOG_FLOAT, px0, &(kNearestArr[0][0]))
LOG_ADD(LOG_FLOAT, py0, &(kNearestArr[0][1]))
LOG_ADD(LOG_FLOAT, pz0, &(kNearestArr[0][2]))
LOG_ADD(LOG_FLOAT, vx0, &(kNearestArr[0][3]))
LOG_ADD(LOG_FLOAT, vy0, &(kNearestArr[0][4]))
LOG_ADD(LOG_FLOAT, vz0, &(kNearestArr[0][5]))

LOG_ADD(LOG_FLOAT, px1, &(kNearestArr[1][0]))
LOG_ADD(LOG_FLOAT, py1, &(kNearestArr[1][1]))
LOG_ADD(LOG_FLOAT, pz1, &(kNearestArr[1][2]))
LOG_ADD(LOG_FLOAT, vx1, &(kNearestArr[1][3]))
LOG_ADD(LOG_FLOAT, vy1, &(kNearestArr[1][4]))
LOG_ADD(LOG_FLOAT, vz1, &(kNearestArr[1][5]))

LOG_ADD(LOG_FLOAT, px2, &(kNearestArr[2][0]))
LOG_ADD(LOG_FLOAT, py2, &(kNearestArr[2][1]))
LOG_ADD(LOG_FLOAT, pz2, &(kNearestArr[2][2]))
LOG_ADD(LOG_FLOAT, vx2, &(kNearestArr[2][3]))
LOG_ADD(LOG_FLOAT, vy2, &(kNearestArr[2][4]))
LOG_ADD(LOG_FLOAT, vz2, &(kNearestArr[2][5]))

LOG_ADD(LOG_FLOAT, px3, &(kNearestArr[3][0]))
LOG_ADD(LOG_FLOAT, py3, &(kNearestArr[3][1]))
LOG_ADD(LOG_FLOAT, pz3, &(kNearestArr[3][2]))
LOG_ADD(LOG_FLOAT, vx3, &(kNearestArr[3][3]))
LOG_ADD(LOG_FLOAT, vy3, &(kNearestArr[3][4]))
LOG_ADD(LOG_FLOAT, vz3, &(kNearestArr[3][5]))

LOG_ADD(LOG_FLOAT, px4, &(kNearestArr[4][0]))
LOG_ADD(LOG_FLOAT, py4, &(kNearestArr[4][1]))
LOG_ADD(LOG_FLOAT, pz4, &(kNearestArr[4][2]))
LOG_ADD(LOG_FLOAT, vx4, &(kNearestArr[4][3]))
LOG_ADD(LOG_FLOAT, vy4, &(kNearestArr[4][4]))
LOG_ADD(LOG_FLOAT, vz4, &(kNearestArr[4][5]))

LOG_ADD(LOG_FLOAT, px5, &(kNearestArr[5][0]))
LOG_ADD(LOG_FLOAT, py5, &(kNearestArr[5][1]))
LOG_ADD(LOG_FLOAT, pz5, &(kNearestArr[5][2]))
LOG_ADD(LOG_FLOAT, vx5, &(kNearestArr[5][3]))
LOG_ADD(LOG_FLOAT, vy5, &(kNearestArr[5][4]))
LOG_ADD(LOG_FLOAT, vz5, &(kNearestArr[5][5]))

LOG_ADD(LOG_FLOAT, targetx, &(ownTarget[0]))
LOG_ADD(LOG_FLOAT, targety, &(ownTarget[1]))
LOG_ADD(LOG_FLOAT, targetz, &(ownTarget[2]))

LOG_ADD(LOG_FLOAT, out0_0, &(output_0[0]))
LOG_ADD(LOG_FLOAT, out0_1, &(output_0[1]))
LOG_ADD(LOG_FLOAT, out0_2, &(output_0[2]))
LOG_ADD(LOG_FLOAT, out0_3, &(output_0[3]))
LOG_ADD(LOG_FLOAT, out0_4, &(output_0[4]))
LOG_ADD(LOG_FLOAT, out0_5, &(output_0[5]))
LOG_ADD(LOG_FLOAT, out0_6, &(output_0[6]))
LOG_ADD(LOG_FLOAT, out0_7, &(output_0[7]))

LOG_ADD(LOG_FLOAT, out1_0, &(output_1[0]))
LOG_ADD(LOG_FLOAT, out1_1, &(output_1[1]))
LOG_ADD(LOG_FLOAT, out1_2, &(output_1[2]))
LOG_ADD(LOG_FLOAT, out1_3, &(output_1[3]))
LOG_ADD(LOG_FLOAT, out1_4, &(output_1[4]))
LOG_ADD(LOG_FLOAT, out1_5, &(output_1[5]))
LOG_ADD(LOG_FLOAT, out1_6, &(output_1[6]))
LOG_ADD(LOG_FLOAT, out1_7, &(output_1[7]))

LOG_ADD(LOG_FLOAT, out2_0, &(output_2[0]))
LOG_ADD(LOG_FLOAT, out2_1, &(output_2[1]))
LOG_ADD(LOG_FLOAT, out2_2, &(output_2[2]))
LOG_ADD(LOG_FLOAT, out2_3, &(output_2[3]))
LOG_ADD(LOG_FLOAT, out2_4, &(output_2[4]))
LOG_ADD(LOG_FLOAT, out2_5, &(output_2[5]))
LOG_ADD(LOG_FLOAT, out2_6, &(output_2[6]))
LOG_ADD(LOG_FLOAT, out2_7, &(output_2[7]))
LOG_ADD(LOG_FLOAT, out2_8, &(output_2[8]))
LOG_ADD(LOG_FLOAT, out2_9, &(output_2[9]))
LOG_ADD(LOG_FLOAT, out2_10, &(output_2[10]))
LOG_ADD(LOG_FLOAT, out2_11, &(output_2[11]))
LOG_ADD(LOG_FLOAT, out2_12, &(output_2[12]))
LOG_ADD(LOG_FLOAT, out2_13, &(output_2[13]))
LOG_ADD(LOG_FLOAT, out2_14, &(output_2[14]))
LOG_ADD(LOG_FLOAT, out2_15, &(output_2[15]))

LOG_ADD(LOG_FLOAT, out3_0, &(output_3[0]))
LOG_ADD(LOG_FLOAT, out3_1, &(output_3[1]))
LOG_ADD(LOG_FLOAT, out3_2, &(output_3[2]))
LOG_ADD(LOG_FLOAT, out3_3, &(output_3[3]))
LOG_ADD(LOG_FLOAT, out3_4, &(output_3[4]))
LOG_ADD(LOG_FLOAT, out3_5, &(output_3[5]))
LOG_ADD(LOG_FLOAT, out3_6, &(output_3[6]))
LOG_ADD(LOG_FLOAT, out3_7, &(output_3[7]))
LOG_ADD(LOG_FLOAT, out3_8, &(output_3[8]))
LOG_ADD(LOG_FLOAT, out3_9, &(output_3[9]))
LOG_ADD(LOG_FLOAT, out3_10, &(output_3[10]))
LOG_ADD(LOG_FLOAT, out3_11, &(output_3[11]))
LOG_ADD(LOG_FLOAT, out3_12, &(output_3[12]))
LOG_ADD(LOG_FLOAT, out3_13, &(output_3[13]))
LOG_ADD(LOG_FLOAT, out3_14, &(output_3[14]))
LOG_ADD(LOG_FLOAT, out3_15, &(output_3[15]))

LOG_ADD(LOG_FLOAT, out4_0,    &(output_4[0]))
LOG_ADD(LOG_FLOAT, out4_1,    &(output_4[1]))
LOG_ADD(LOG_FLOAT, out4_2,    &(output_4[2]))
LOG_ADD(LOG_FLOAT, out4_3,    &(output_4[3]))
LOG_ADD(LOG_FLOAT, out4_4,    &(output_4[4]))
LOG_ADD(LOG_FLOAT, out4_5,    &(output_4[5]))
LOG_ADD(LOG_FLOAT, out4_6,    &(output_4[6]))
LOG_ADD(LOG_FLOAT, out4_7,    &(output_4[7]))
LOG_ADD(LOG_FLOAT, out4_8,    &(output_4[8]))
LOG_ADD(LOG_FLOAT, out4_9,    &(output_4[9]))
LOG_ADD(LOG_FLOAT, out4_10,   &(output_4[10]))
LOG_ADD(LOG_FLOAT, out4_11,   &(output_4[11]))
LOG_ADD(LOG_FLOAT, out4_12,   &(output_4[12]))
LOG_ADD(LOG_FLOAT, out4_13,   &(output_4[13]))
LOG_ADD(LOG_FLOAT, out4_14,   &(output_4[14]))
LOG_ADD(LOG_FLOAT, out4_15,   &(output_4[15]))
LOG_ADD(LOG_FLOAT, out4_16,   &(output_4[16]))
LOG_ADD(LOG_FLOAT, out4_17,   &(output_4[17]))
LOG_ADD(LOG_FLOAT, out4_18,   &(output_4[18]))
LOG_ADD(LOG_FLOAT, out4_19,   &(output_4[19]))
LOG_ADD(LOG_FLOAT, out4_20,   &(output_4[20]))
LOG_ADD(LOG_FLOAT, out4_21,   &(output_4[21]))
LOG_ADD(LOG_FLOAT, out4_22,   &(output_4[22]))
LOG_ADD(LOG_FLOAT, out4_23,   &(output_4[23]))
LOG_ADD(LOG_FLOAT, out4_4,    &(output_4[24]))
LOG_ADD(LOG_FLOAT, out4_5,    &(output_4[25]))
LOG_ADD(LOG_FLOAT, out4_6,    &(output_4[26]))
LOG_ADD(LOG_FLOAT, out4_7,    &(output_4[27]))
LOG_ADD(LOG_FLOAT, out4_8,    &(output_4[28]))
LOG_ADD(LOG_FLOAT, out4_9,    &(output_4[29]))
LOG_ADD(LOG_FLOAT, out4_10,   &(output_4[30]))
LOG_ADD(LOG_FLOAT, out4_11,   &(output_4[31]))

LOG_ADD(LOG_FLOAT, inputff_0,    &(inputff[0]))
LOG_ADD(LOG_FLOAT, inputff_1,    &(inputff[1]))
LOG_ADD(LOG_FLOAT, inputff_2,    &(inputff[2]))
LOG_ADD(LOG_FLOAT, inputff_3,    &(inputff[3]))
LOG_ADD(LOG_FLOAT, inputff_4,    &(inputff[4]))
LOG_ADD(LOG_FLOAT, inputff_5,    &(inputff[5]))
LOG_ADD(LOG_FLOAT, inputff_6,    &(inputff[6]))
LOG_ADD(LOG_FLOAT, inputff_7,    &(inputff[7]))
LOG_ADD(LOG_FLOAT, inputff_8,    &(inputff[8]))
LOG_ADD(LOG_FLOAT, inputff_9,    &(inputff[9]))
LOG_ADD(LOG_FLOAT, inputff_10,   &(inputff[10]))
LOG_ADD(LOG_FLOAT, inputff_11,   &(inputff[11]))
LOG_ADD(LOG_FLOAT, inputff_12,   &(inputff[12]))
LOG_ADD(LOG_FLOAT, inputff_13,   &(inputff[13]))
LOG_ADD(LOG_FLOAT, inputff_14,   &(inputff[14]))
LOG_ADD(LOG_FLOAT, inputff_15,   &(inputff[15]))
LOG_ADD(LOG_FLOAT, inputff_16,   &(inputff[16]))
LOG_ADD(LOG_FLOAT, inputff_17,   &(inputff[17]))
LOG_ADD(LOG_FLOAT, inputff_18,   &(inputff[18]))
LOG_ADD(LOG_FLOAT, inputff_19,   &(inputff[19]))
LOG_ADD(LOG_FLOAT, inputff_20,   &(inputff[20]))
LOG_ADD(LOG_FLOAT, inputff_21,   &(inputff[21]))
LOG_ADD(LOG_FLOAT, inputff_22,   &(inputff[22]))
LOG_ADD(LOG_FLOAT, inputff_23,   &(inputff[23]))


LOG_ADD(LOG_FLOAT, out5_0,  &(output_5[0]))
LOG_ADD(LOG_FLOAT, out5_1,  &(output_5[1]))
LOG_ADD(LOG_FLOAT, out5_2,  &(output_5[2]))
LOG_ADD(LOG_FLOAT, out5_3,  &(output_5[3]))

LOG_GROUP_STOP(logNN)



